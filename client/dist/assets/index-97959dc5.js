import{a as te,V as ft,o as i,c as y,b as r,m as ee,d as $e,r as Le,n as Ge,g as yt,e as l,f as qe,h as f,t as p,i as x,j as je,k as ge,l as U,p as z,q as m,s as H,F as b,u as d,v as P,x as Me,y as Fe,z as A,A as Qe,B as $,C as R,D as C,E as de,G as V,H as S,I as v,J as F,K as W,L,M as _,N as k,O,P as w,Q as N,R as lt,S as Ne,T as De,U as Ze,W as gt,X as _t,Y as ie,Z as We,_ as Ve,$ as bt,a0 as _e,a1 as be,a2 as Tt,a3 as kt,a4 as vt,a5 as It,a6 as Ct,a7 as wt,a8 as Pt,a9 as Dt,aa as St,ab as Q,ac as Te,ad as Ke,ae as ce,af as at,ag as st,ah as Je,ai as rt,aj as Se,ak as nt,al as Mt,am as Ft,an as Vt,ao as xt,ap as q,aq as Ot,ar as At,as as Et,at as Bt,au as Lt}from"./vendor-9614aa36.js";import"./index-97959dc5.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))c(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const u of n.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function o(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(a){if(a.ep)return;a.ep=!0;const n=o(a);fetch(a.href,n)}})();const Xe=e=>{switch(e){case"node":return"http://192.168.0.11:4000/api";case"laravel":return"http://192.168.0.200:8002/api";default:return"http://localhost:4000/api"}},D=te.create({baseURL:Xe("node")});te.create({baseURL:Xe("laravel")});function T(e){throw e.response?(console.error("Ошибка от сервера:",e.response.data),console.error("Статус:",e.response.status),console.error("Заголовки:",e.response.headers)):e.request?console.error("Запрос был сделан, но ответ не получен:",e.request):console.error("Ошибка при настройке запроса:",e.message),console.error("Конфигурация запроса:",e.config),e}async function pe(e){return e.data}const j={getTools:async(e="",t=1,o=10,c=!1,a=null,n=!0,u={})=>{const s={search:e,page:t,limit:o,includeNull:c,onlyInStock:n,parent_id:a,...u};return D.get("/tools",{params:s}).then(pe).catch(T)},getToolById:async e=>D.get(`/tool/modal-form/${e}`).then(pe).catch(T),filterParamsByParentId:async e=>D.get(`/tools/params/${e}/filter`).then(pe).catch(T)};async function xe(){return D.get("/tools-params").then(pe).catch(T)}const Ut={namespaced:!0,state:()=>({selectedFio:null,selectedOperationId:null,isModalOpen:!1,cartItems:[],isLoading:!1,parentCatalog:{id:1,label:null},dynamicFilters:[],nameOptions:[],tool:null,tools:[],toolsTotalCount:0,cart:[],filters:{currentPage:1,itemsPerPage:15,search:"",includeNull:!1,selectedDynamicFilters:{}}}),mutations:{CLEAR_CART(e){e.cart=[]},UPDATE_CATALOG_FROM_SESSION(e,t){e.catalog=t},setSelectedFio(e,t){e.selectedFio=t},setSelectedOperationId(e,t){e.selectedOperationId=t},setSelectedDetail(e,t){e.selectedDetail=t},SET_MODAL_STATUS(e,t){e.isModalOpen=t},addToCart(e,{toolId:t,quantity:o,name:c,sklad:a}){const n=e.cart.find(u=>u.toolId===t);n?n.quantity+=o:e.cart.push({toolId:t,quantity:o,name:c,sklad:a})},removeFromCart(e,t){const o=e.cart.findIndex(c=>c.toolId===t);o!==-1&&e.cart.splice(o,1)},updateCartItemQuantity(e,{toolId:t,quantity:o}){const c=e.cart.find(a=>a.toolId===t);c&&(c.quantity=o)},setSearch(e,t){e.filters.search=t},setParentCatalog(e,t){e.parentCatalog={...t}},setDynamicFilters(e,t){e.dynamicFilters=t},setSelectedDynamicFilters(e,t){e.filters.selectedDynamicFilters=t},setIsLoading(e,t){e.isLoading=t},setCurrentPage(e,t){e.filters.currentPage=t},setFilters(e,t){e.filters={...t}},setTool(e,t){e.tool=t},setItemsPerPage(e,t){e.filters.itemsPerPage=t},setToolsTotalCount(e,t){e.toolsTotalCount=t},setTools(e,t){e.tools=t}},actions:{updateParentCatalog({commit:e,dispatch:t},o){e("setParentCatalog",o),t("fetchToolsByFilter")},clearCart({commit:e}){e("CLEAR_CART")},updateCatalogFromSession({commit:e},t){e("UPDATE_CATALOG_FROM_SESSION",t)},openModal({commit:e}){e("SET_MODAL_STATUS",!0)},closeModal({commit:e}){e("SET_MODAL_STATUS",!1)},addToCartAction({commit:e},{toolId:t,quantity:o,name:c,sklad:a}){e("addToCart",{toolId:t,quantity:o,name:c,sklad:a})},removeFromCartAction({commit:e},t){e("removeFromCart",t)},updateCartItemQuantityAction({commit:e},t){e("updateCartItemQuantity",t)},async fetchToolById({commit:e},t){try{const o=await j.getToolById(t);e("setTool",o)}catch(o){console.error("Ошибка при загрузке инструмента:",o)}},async fetchToolsDynamicFilters({commit:e,state:t}){const{id:o=null}=t.parentCatalog;if(o!==null)try{const c=await j.filterParamsByParentId(o);e("setSelectedDynamicFilters",c.reduce((a,{key:n})=>({...a,[n]:null}),{})),e("setDynamicFilters",c)}catch(c){console.error("Ошибка при загрузке динамических фильтров:",c)}},async fetchToolsByFilter({commit:e,state:t}){const o={...t.filters.selectedDynamicFilters};e("setIsLoading",!0);const{currentPage:c,itemsPerPage:a,search:n,includeNull:u,onlyInStock:s=!0,selectedDynamicFilters:h}=t.filters,{id:g}=t.parentCatalog,M=new URLSearchParams({page:c,limit:a,includeNull:u,onlyInStock:s,search:n});g!==null&&M.append("parent_id",g);try{const{tools:E,totalCount:Oe}=await j.getTools(n,c,a,u,g,s,Object.entries(h).reduce((Ae,[Ee,Be])=>({...Ae,[`param_${Ee}`]:Be}),{}));e("setTools",E),e("setToolsTotalCount",Oe),e("setSelectedDynamicFilters",o)}catch(E){console.error("getTools. Ошибка при получении данных:",E)}finally{e("setIsLoading",!1)}}},getters:{selectedFio:e=>e.selectedFio,selectedOperationId:e=>e.selectedOperationId,cartItems:e=>e.cart,parentCatalog:e=>e.parentCatalog,dynamicFilters:e=>e.dynamicFilters,filters:e=>({...e.filters}),tool:e=>e.tool?{...e.tool,property:e.tool.property,parent_id:e.tool.parent_id,folder_name:e.tool.folder_name}:null,tools:e=>[...e.tools],formattedTools:e=>e.tools.map(t=>({...t,...Object.entries(t.property).reduce((o,[c,{value:a}])=>({...o,[c]:a}),{})})),isLoading:e=>e.isLoading,nameOptions:e=>e.nameOptions,toolsTotalCount:e=>e.toolsTotalCount}},it={namespaced:!0,state:()=>({isLoading:!1,parentCatalog:{id:1,label:null},dynamicFilters:[],nameOptions:[],tool:null,tools:[],toolsTotalCount:0,filters:{currentPage:1,itemsPerPage:15,search:"",includeNull:!1,selectedDynamicFilters:{}}}),mutations:{setSearch(e,t){e.filters.search=t},setParentCatalog(e,t){e.parentCatalog={...t}},setDynamicFilters(e,t){e.dynamicFilters=t},setSelectedDynamicFilters(e,t){e.filters.selectedDynamicFilters=t},setIsLoading(e,t){e.isLoading=t},setCurrentPage(e,t){e.filters.currentPage=t},setFilters(e,t){e.filters={...t}},setTool(e,t){e.tool=t},setItemsPerPage(e,t){e.filters.itemsPerPage=t},setToolsTotalCount(e,t){e.toolsTotalCount=t},setTools(e,t){e.tools=t}},actions:{async fetchToolById({commit:e},t){try{const o=await j.getToolById(t);e("setTool",o)}catch(o){console.error("Ошибка при загрузке инструмента:",o)}},async fetchToolsDynamicFilters({commit:e,state:t}){const{id:o=null}=t.parentCatalog;if(o!==null)try{const c=await j.filterParamsByParentId(o);e("setSelectedDynamicFilters",c.reduce((a,{key:n})=>({...a,[n]:null}),{})),e("setDynamicFilters",c)}catch(c){console.error("Ошибка при загрузке динамических фильтров:",c)}},async fetchToolsByFilter({commit:e,state:t}){const o={...t.filters.selectedDynamicFilters};e("setIsLoading",!0);const{currentPage:c,itemsPerPage:a,search:n,includeNull:u,onlyInStock:s=null,selectedDynamicFilters:h}=t.filters,{id:g}=t.parentCatalog,M=new URLSearchParams({page:c,limit:a,includeNull:u,onlyInStock:s,search:n});g!==null&&M.append("parent_id",g);try{const{tools:E,totalCount:Oe}=await j.getTools(n,c,a,u,g,s,Object.entries(h).reduce((Ae,[Ee,Be])=>({...Ae,[`param_${Ee}`]:Be}),{}));e("setTools",E),e("setToolsTotalCount",Oe),e("setSelectedDynamicFilters",o)}catch(E){console.error("getTools. Ошибка при получении данных:",E)}finally{e("setIsLoading",!1)}}},getters:{parentCatalog:e=>e.parentCatalog,dynamicFilters:e=>e.dynamicFilters,filters:e=>({...e.filters}),tool:e=>e.tool?{...e.tool,property:e.tool.property,parent_id:e.tool.parent_id,folder_name:e.tool.folder_name}:null,tools:e=>[...e.tools],formattedTools:e=>e.tools.map(t=>({...t,...Object.entries(t.property).reduce((o,[c,{value:a}])=>({...o,[c]:a}),{})})),isLoading:e=>e.isLoading,nameOptions:e=>e.nameOptions,toolsTotalCount:e=>e.toolsTotalCount}},Ht={namespaced:!0,state:{isAuthorized:!1,userRole:null},mutations:{SET_AUTHORIZED(e,t){e.isAuthorized=t},SET_USER_ROLE(e,t){e.userRole=t}},actions:{async login({commit:e},{login:t,password:o}){try{const c=await D.post("/login",{login:t,password:o});return c.data.status==="ok"?(localStorage.setItem("token",c.data.token),e("SET_AUTHORIZED",!0),e("SET_USER_ROLE",c.data.role),!0):!1}catch(c){throw console.error("Login error:",c),new Error("Ошибка авторизации")}},logout({commit:e}){localStorage.removeItem("token"),e("SET_AUTHORIZED",!1),e("SET_USER_ROLE",null)}}},fe=new ft.Store({modules:{IssueToolStore:Ut,AuthStore:Ht,ViewToolStore:it}}),Rt=[{title:"Отдел ТО и ПП",icon:"mdi-tools",access:["admin","hohlov"],items:[{title:"Инструмент",path:"/Tool"}]},{title:"Другое",access:["admin","hohlov"],items:[{title:"QR-code",path:"/QR-code",icon:"mdi-qrcode"}]}],I=(e,t)=>{const o=e.__vccOpts||e;for(const[c,a]of t)o[c]=a;return o},Nt={props:{title:{type:String,default:"По операции"},modalProps:{type:Object,default:()=>({})},widthDefault:{type:String,default:"500"}}};function zt(e,t,o,c,a,n){return i(),y($e,ee({persistent:"","model-value":!0},o.modalProps,{width:o.widthDefault}),{activator:r(({props:u})=>[Le(e.$slots,"default",Ge(yt(u)))]),default:r(()=>[l(ge,null,{default:r(()=>[l(qe,null,{default:r(()=>[f(p(o.title),1)]),_:1}),l(x),Le(e.$slots,"content"),l(x),l(je,null,{default:r(()=>[Le(e.$slots,"action")]),_:3})]),_:3})]),_:3},16,["width"])}const G=I(Nt,[["render",zt]]),K=te.create({baseURL:"http://192.168.0.11:4000/api"});function J(e){return e.data}const Y={getDetailFio:async()=>K.get("modal-form/operators/fio").then(J).catch(T),searchById:async e=>K.get("modal-form/parties",{params:{id:e}}).then(J).catch(T),fetchCncList:async()=>K.get("modal-form/cnc").then(J).catch(T),addHistoryTool:async e=>K.post("issue",e).then(J).catch(T),addHistoryTools:async e=>K.post("issues",e).then(J).catch(T),addToolHistoryDamaged:async e=>K.post("tool-history-damaged",e).then(J).catch(T),getToolHistoryByOperationId:async e=>K.get("history-operation",{params:{operationId:e}}).then(J).catch(T)};const $t={props:{operationId:{type:Number,required:!0}},data(){return{historyItems:[],tableStructure:[{header:"Дата",data:"timestamp"},{header:"Инструмент",data:"name_tool"},{header:"Кол-во",data:"quantity"},{header:"Тип выдачи",data:"type_issue"},{header:"Выдал",data:"issuer_fio"},{header:"Выдано",data:"user_fio"}]}},computed:{...U("IssueToolStore",["cartItems"])},async created(){await this.fetchToolHistory()},watch:{operationId(e,t){e!==t&&this.fetchToolHistory()}},methods:{async fetchToolHistory(){try{this.historyItems=await Y.getToolHistoryByOperationId(this.operationId)}catch(e){e.response&&e.response.status===404?this.historyItems=[]:console.error("Ошибка при получении истории по операции:",e)}},formatDate(e){return z(new Date(e),"dd.MM.yy HH:mm")},isToolInCart(e){return console.log(e),this.cartItems.some(t=>t.toolId===e)}}},Gt=e=>(Me("data-v-894b7231"),e=e(),Fe(),e),qt=Gt(()=>d("div",{class:"text-h6"},"Уже было выдано на операцию",-1));function jt(e,t,o,c,a,n){return i(),m(b,null,[qt,l(H,{hover:""},{default:r(()=>[d("thead",null,[d("tr",null,[(i(!0),m(b,null,P(a.tableStructure,(u,s)=>(i(),m("th",{key:s},p(u.header),1))),128))])]),d("tbody",null,[(i(!0),m(b,null,P(a.historyItems,(u,s)=>(i(),m("tr",{key:s,class:A({"highlight-row":n.isToolInCart(u.id_tool)})},[(i(!0),m(b,null,P(a.tableStructure,(h,g)=>(i(),m("td",{key:g},p(h.data==="timestamp"?n.formatDate(u[h.data]):u[h.data]),1))),128))],2))),128))])]),_:1})],64)}const Qt=I($t,[["render",jt],["__scopeId","data-v-894b7231"]]);function Ue(e){return e.data}const B={getTree:async(e={})=>D.get("/tools-tree",{params:e}).then(Ue).catch(T),addFolder:async(e,t)=>D.post("/tools-tree",{name:e,parentId:t}).then(Ue).catch(T),deleteFolder:async e=>D.delete(`/tools-tree/${e}`).catch(T),renameFolder:async(e,t)=>D.put("/tools-tree",{id:e,newName:t}).then(Ue).catch(T)};const Zt={name:"CartModal",components:{Modal:G,ModalTableOperaton:Qt},props:{persistent:{type:Boolean,default:!1},toolId:{type:Number,default:null}},emits:["canceled","changes-saved","updatePage"],data:()=>({selectedFio:null,typeIssueOptions:[{title:"Себе",id:0},{title:"На ночь",id:1},{title:"Наладка",id:2}],tree:[],issueToken:"",submitButtonDisabled:!1,isSubmitting:!1,submitError:!1,snackbar:!1,snackbarText:"",item:{cnc_type:"",fio:""},damagedQuantity:1,comment:null,selectedCnc:null,cncList:[],originalData:[],idMapping:{},fioOptions:[],selectedData:{name:null,description:null,no:null,type:null},localParentId:null,toolModel:{selectedOperationId:null,detailDescription:null,operationType:null},selectedParams:[],toolParams:[],confirmDeleteDialog:!1,typeSelected:!1,selectedType:"",operationMapping:{},issueTypeRules:[e=>!!e||"Тип выдачи обязателен для выбора"],options:{idNameDescription:[],numberType:[]}}),computed:{...U("IssueToolStore",["nameOptions","tool","parentCatalog","cartItems"]),...Qe("IssueToolStore",["isModalOpen","parentCatalog"]),selectedFioModel:{get(){return this.selectedFio},set(e){this.handleSelectionChange(e)}},cartItemsTotalQuantity(){return this.cartItems?this.cartItems.reduce((e,t)=>e+t.quantity,0):0},currentFolderName(){return this.toolId===null?this.idParent.label:this.tool.folder_name},popupTitle(){return"Корзина"},modalWidth(){return this.toolModel.operationType?"1200px":"600px"}},watch:{"toolModel.detailDescription"(e,t){e!==t&&(this.toolModel.operationType=null)},tool:{deep:!0,immediate:!0,async handler(e){e==null?this.resetToolModel():(await this.fetchToolById(e),this.updateToolModel())}}},async created(){try{const t=await Y.getDetailFio();this.fioOptions=this.prepareFioOptions(t)}catch(t){console.error("Ошибка при загрузке данных ФИО:",t)}const e=await B.getTree();e&&e.length>0&&(this.currentItem=e[0],this.currentItem&&this.tree.push(this.currentItem))},methods:{...$("IssueToolStore",["setTool"]),...R("IssueToolStore",["fetchToolsByFilter","fetchToolById","addToCartAction","updateCartItemQuantityAction","removeFromCartAction"]),onOperationSelected(e){const t=this.operationMapping[e];t?this.toolModel.operationType=t:(console.error("Не удалось найти ID операции для:",e),this.toolModel.operationType=null)},formatToolOptions(e){const t=new Set;return this.idMapping={},e.forEach(o=>{const c=o.description?`${o.id} - ${o.name} - ${o.description}`:`${o.id} - ${o.name}`;t.has(c)||(t.add(c),this.idMapping[c]=o.id)}),Array.from(t)},handleSelectionChange(e){this.selectedFio=e},onIdSelected(e){const t=this.idMapping[e];if(t){const o=this.originalData.filter(c=>c.id===t);this.options.numberType=this.formatOperationOptions(o),this.toolModel.operationType=null,this.toolModel.numberType=null}else console.error("Не удалось найти ID для выбранного значения:",e),this.options.numberType=[],this.toolModel.operationType=null,this.toolModel.numberType=null},async onIdChanged(e){try{const t=await Y.searchById(e);this.originalData=t,this.options.idNameDescription=this.formatToolOptions(t)}catch(t){console.error("Ошибка при поиске:",t)}},async sendIssueDataToApi(){const e={issueToken:this.issueToken,operationId:this.toolModel.operationType,userId:this.selectedFio.value,typeIssue:this.toolModel.typeIssue.id,tools:this.cartItems.map(t=>({toolId:t.toolId,quantity:t.quantity}))};try{const t=await Y.addHistoryTools(e);if(t&&t.success==="OK")return this.snackbarText="Успешно выдано",this.snackbar=!0,this.$emit("changes-saved"),this.$emit("canceled"),this.$store.dispatch("IssueToolStore/clearCart"),!0}catch(t){return this.snackbarText=t.message||"Произошла ошибка при отправке данных",this.snackbar=!0,this.submitButtonDisabled=!0,setTimeout(()=>{this.submitButtonDisabled=!1},5e3),!1}},async onSave(){this.isSubmitting=!0;try{this.issueToken=localStorage.getItem("token"),this.issueToken||new Error("Authentication token not found."),await this.sendIssueDataToApi()&&(this.snackbarText="Успешно выдано",this.snackbar=!0,this.$emit("changes-saved"),this.$store.dispatch("IssueToolStore/clearCart"),await this.fetchToolsByFilter())}catch(e){console.error("Произошла ошибка при отправке данных:",e),this.snackbarText="Ошибка при отправке данных",this.snackbar=!0}finally{this.isSubmitting=!1}},increaseQuantity(e){const t=this.cartItems[e];t.quantity<t.sklad&&this.updateCartItemQuantityAction({toolId:t.toolId,quantity:t.quantity+1})},resetToolModel(){this.toolModel={name:null,limit:null,sklad:null,norma:null,property:{}}},decreaseQuantity(e){const t=this.cartItems[e];t.quantity>1&&this.updateCartItemQuantityAction({toolId:t.toolId,quantity:t.quantity-1})},prepareFioOptions(e){return e.map(t=>({text:t.fio,value:t.id}))},formatOperationOptions(e){const t=new Set;return e.forEach(o=>{const c=`${o.no} - ${o.cnc_type}`;t.has(c)||(t.add(c),this.operationMapping[c]=o.specs_op_id)}),Array.from(t)},onCancel(){this.$emit("canceled")}}},Wt={class:"d-flex"},Kt={class:"flex-grow-1 mr-2 ml-2",style:{"flex-basis":"40%"}},Jt=d("div",{class:"text-h6 pl-5 mb-2"},"Выбрать деталь:",-1),Xt=d("h2",{class:"text-h6 pl-5 mb-2"},"Кому выдать:",-1),Yt=d("thead",null,[d("tr",null,[d("th"),d("th",null,"Инструмент"),d("th",null,"Кол-во"),d("th",null,"Склад"),d("th")])],-1),eo={class:"gray"},to={class:"d-flex align-center"},oo={class:"mx-2"},lo={key:0,class:"flex-grow-1 ml-2",style:{"flex-basis":"60%"}};function ao(e,t,o,c,a,n){const u=C("ModalTableOperaton"),s=C("Modal");return i(),m(b,null,[l(de,{modelValue:e.snackbar,"onUpdate:modelValue":t[0]||(t[0]=h=>e.snackbar=h),timeout:3e3,color:"error"},{default:r(()=>[f(p(e.snackbarText),1)]),_:1},8,["modelValue"]),l(s,{title:n.popupTitle,width:n.modalWidth,transition:"slide-x-reverse-transition"},{content:r(()=>[l(V,null,{default:r(()=>[d("div",Wt,[d("div",Kt,[Jt,l(S,null,{default:r(()=>[l(v,null,{default:r(()=>[l(F,{variant:"outlined",label:"поиск детали по партии",required:"",clearable:"","onUpdate:modelValue":n.onIdChanged},null,8,["onUpdate:modelValue"]),l(W,{modelValue:e.toolModel.detailDescription,"onUpdate:modelValue":[t[1]||(t[1]=h=>e.toolModel.detailDescription=h),n.onIdSelected],label:"Название Обозначение",required:"",disabled:!e.options.idNameDescription.length,items:e.options.idNameDescription,clearable:""},null,8,["modelValue","disabled","items","onUpdate:modelValue"]),l(W,{modelValue:e.toolModel.numberType,"onUpdate:modelValue":[t[2]||(t[2]=h=>e.toolModel.numberType=h),n.onOperationSelected],label:"Номер Тип",required:"",disabled:!e.options.numberType.length,items:e.options.numberType,"item-value":"id","item-text":"text",clearable:""},null,8,["modelValue","disabled","items","onUpdate:modelValue"]),Xt,l(L,{modelValue:e.selectedFio,"onUpdate:modelValue":[t[3]||(t[3]=h=>e.selectedFio=h),n.handleSelectionChange],icon:"mdi-account",items:e.fioOptions,"item-title":"text","item-value":"value",label:"ФИО",clearable:""},null,8,["modelValue","items","onUpdate:modelValue"]),l(L,{modelValue:e.toolModel.typeIssue,"onUpdate:modelValue":t[4]||(t[4]=h=>e.toolModel.typeIssue=h),items:e.typeIssueOptions,"item-text":"title","item-value":"id",label:"Тип выдачи",rules:e.issueTypeRules,required:"",clearable:""},null,8,["modelValue","items","rules"])]),_:1})]),_:1}),l(H,{hover:""},{default:r(()=>[Yt,d("tbody",null,[(i(!0),m(b,null,P(e.cartItems,(h,g)=>(i(),m("tr",{key:h.id},[d("td",eo,p(g+1),1),d("td",null,p(h.name),1),d("td",null,[d("div",to,[l(k,{class:"hover-effect-red",icon:"true",size:"x-small",disabled:h.quantity<=1,onClick:M=>n.decreaseQuantity(g)},{default:r(()=>[l(w,{icon:"mdi-minus"})]),_:2},1032,["disabled","onClick"]),d("div",oo,p(h.quantity),1),l(k,{class:"hover-effect-red",icon:"true",size:"x-small",disabled:h.quantity>=e.item.sklad,onClick:M=>n.increaseQuantity(g)},{default:r(()=>[l(w,{icon:"mdi-plus"})]),_:2},1032,["disabled","onClick"])])]),d("td",null,p(h.sklad),1),d("td",null,[l(k,{class:"hover-effect-grey",icon:"true",size:"x-small",onClick:M=>e.removeFromCartAction(h.toolId)},{default:r(()=>[l(w,{icon:"mdi-delete"})]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),e.toolModel.operationType?(i(),m("div",lo,[l(u,{"operation-id":e.toolModel.operationType},null,8,["operation-id"])])):_("",!0)])]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"]),l(x),n.cartItemsTotalQuantity?(i(),y(k,{key:0,"prepend-icon":"mdi-hand-extended",class:"text-none text-subtitle-1 pl-3",color:"blue darken-1",size:"large",variant:"flat",disabled:e.submitButtonDisabled,onClick:n.onSave},{default:r(()=>[f(" Выдать "),l(O,{color:"red",variant:"flat",class:"ml-2"},{default:r(()=>[f(p(n.cartItemsTotalQuantity)+" шт",1)]),_:1})]),_:1},8,["disabled","onClick"])):_("",!0)]),_:1},8,["title","width"])],64)}const so=I(Zt,[["render",ao]]),ro={props:{item:{type:Object,default:()=>({})}},methods:{navigate(){const{path:e}=this.item;e!=null&&this.$router.push({path:e})}}};function no(e,t,o,c,a,n){const u=C("sidebar-menu-item",!0);return o.item.items?(i(),y(lt,{key:1,value:o.item.title},{activator:r(({props:s})=>[l(N,ee(s,{"prepend-icon":o.item.icon,title:o.item.title,onClick:n.navigate}),null,16,["prepend-icon","title","onClick"])]),default:r(()=>[(i(!0),m(b,null,P(o.item.items,(s,h)=>(i(),y(u,{key:h,item:s},null,8,["item"]))),128))]),_:1},8,["value"])):(i(),y(N,{key:0,"prepend-icon":o.item.icon,title:o.item.title,onClick:n.navigate},null,8,["prepend-icon","title","onClick"]))}const io=I(ro,[["render",no]]),co={components:{SidebarMenuItem:io},props:{menuItems:{type:Array,default:()=>[]}},methods:{onNavigate(e){this.$router.push(e)},getIcon(e){return e||"mdi-circle-outline"}}};function uo(e,t,o,c,a,n){const u=C("sidebar-menu-item");return i(),y(Ne,{density:"compact",nav:!0,class:"test"},{default:r(()=>[(i(!0),m(b,null,P(o.menuItems,(s,h)=>(i(),m(b,{key:h},[s.items?(i(),y(lt,{key:1},{activator:r(({props:g})=>[l(N,ee({ref_for:!0},g,{"prepend-icon":n.getIcon(s.icon),title:s.title}),null,16,["prepend-icon","title"])]),default:r(()=>[(i(!0),m(b,null,P(s.items,(g,M)=>(i(),y(u,{key:M,item:g},null,8,["item"]))),128))]),_:2},1024)):(i(),y(N,{key:0,"prepend-icon":n.getIcon(s.icon),title:s.title,onClick:g=>n.onNavigate(s.path)},null,8,["prepend-icon","title","onClick"]))],64))),128))]),_:1})}const ho=I(co,[["render",uo]]);function Ye(e){return e.data}const ye={checkLogin:async()=>{const e=localStorage.getItem("token");return D.post("/check-login",{token:e}).then(Ye).catch(T)},login:async e=>D.post("/login",e).then(Ye).catch(T)},mo="/assets/logoWhite-94a615f6.svg",po="/assets/avatar-2ef83f30.png";const fo={name:"AppHeader",components:{MenuList:ho,ModalCart:so},data:()=>({isRail:!0,isHovered:!1,userInfo:{}}),computed:{...Qe("IssueToolStore",["isModalOpen"]),...U({cartItems:"IssueToolStore/cartItems"}),cartItemsLength(){return this.cartItems?this.cartItems.length:0},cartItemsTotalQuantity(){return this.cartItems?this.cartItems.reduce((e,t)=>e+t.quantity,0):0},appTitle(){return"PF-FORUM"},appColor(){return"cyan-darken-3"},plotsMenuItemsComputed(){return this.filterForHohlov(Rt)},groupStates(){return[]}},async created(){this.userInfo=await ye.checkLogin()},methods:{...R("IssueToolStore",["openModal","closeModal"]),operationId(){return this.selectedOperationId},openCartModal(){this.openModal()},onClosePopup(){this.openDialog=!1,this.currentModal=null},onSaveChanges(){this.onClosePopup()},filterForHohlov(e){return e.filter(t=>t.access&&t.access.includes("hohlov")).map(t=>(t.icon||(t.icon="mdi-circle-outline"),t.items&&(t.items=t.items.map(o=>(o.icon||(o.icon="mdi-circle-outline"),o))),t))},logout(){localStorage.removeItem("token"),this.$router.push("/Login")}}},yo=e=>(Me("data-v-01efb271"),e=e(),Fe(),e),go=yo(()=>d("div",{class:"d-inline-flex align-center mr-2"},"Инструмент к выдаче",-1));function _o(e,t,o,c,a,n){const u=C("ModalCart"),s=C("menu-list");return i(),m("header",null,[e.isModalOpen?(i(),y(u,{key:0,persistent:!0,onCanceled:e.closeModal,onChangesSaved:n.onSaveChanges},null,8,["onCanceled","onChangesSaved"])):_("",!0),l(gt,{class:"header",location:"left",width:"330",permanent:"",rail:e.isRail},{default:r(()=>[l(Ne,null,{default:r(()=>[l(N,{"prepend-avatar":mo,title:"Софт инструмента"})]),_:1}),l(De),l(Ne,null,{default:r(()=>[l(N,{"prepend-avatar":po,title:e.userInfo.user,subtitle:n.appTitle},null,8,["title","subtitle"])]),_:1}),l(De),e.isHovered?(i(),y(N,{key:0},{default:r(()=>[l(Ze,null,{default:r(()=>[f("Участки")]),_:1})]),_:1})):_("",!0),l(s,{"menu-items":n.plotsMenuItemsComputed,"group-states":n.groupStates},null,8,["menu-items","group-states"])]),_:1},8,["rail"]),l(Ve,{color:n.appColor,sticky:"",prominent:"",dark:""},{default:r(()=>[l(_t,{variant:"text",onClick:t[0]||(t[0]=ie(h=>e.isRail=!e.isRail,["stop"]))}),l(We,null,{default:r(()=>[f(p(n.appTitle),1)]),_:1}),l(x),n.cartItemsLength>0?(i(),m("div",{key:0,class:"ma-5",onClick:t[1]||(t[1]=(...h)=>n.openCartModal&&n.openCartModal(...h))},[l(k,{icon:""},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-cart-outline")]),_:1})]),_:1}),go,l(O,{color:"red",variant:"flat"},{default:r(()=>[f(p(n.cartItemsTotalQuantity),1)]),_:1})])):_("",!0),e.userInfo.user?(i(),y(O,{key:1,class:"ma-2",label:"",dark:""},{prepend:r(()=>[l(w,{icon:"mdi-account",start:""})]),default:r(()=>[f(" "+p(e.userInfo.user),1)]),_:1})):_("",!0),l(k,{icon:""},{default:r(()=>[l(w,{onClick:n.logout},{default:r(()=>[f("mdi-exit-to-app")]),_:1},8,["onClick"])]),_:1})]),_:1},8,["color"])])}const bo=I(fo,[["render",_o],["__scopeId","data-v-01efb271"]]),To={name:"AppFooter"};function ko(e,t,o,c,a,n){const u=C("router-view");return i(),y(V,null,{default:r(()=>[l(u)]),_:1})}const vo=I(To,[["render",ko]]);async function Io(){return D.get("/database-info").then(pe).catch(T)}const Co={name:"AppFooter",data(){return{databaseInfo:null}},computed:{isBuildDatabase(){return this.databaseInfo&&this.databaseInfo.databaseType==="build"}},async mounted(){try{this.databaseInfo=await Io()}catch(e){console.error("Failed to load database info:",e)}}};function wo(e,t,o,c,a,n){return a.databaseInfo?(i(),y(bt,{key:0,class:"container"},{default:r(()=>[l(O,{variant:"plain",density:"compact"},{default:r(()=>[f(" Все права защищены © 2024 ")]),_:1}),l(x),l(O,{color:a.databaseInfo.dbName==="BusinessForum"?"red":"green",density:"compact"},{default:r(()=>[a.databaseInfo.dbName==="BusinessForum"?(i(),m(b,{key:0},[f(" Версия: "+p(a.databaseInfo.databaseType),1)],64)):(i(),m(b,{key:1},[l(w,{left:"",icon:"mdi-database"}),f(" "+p(a.databaseInfo.dbName),1)],64))]),_:1},8,["color"])]),_:1})):_("",!0)}const Po=I(Co,[["render",wo],["__scopeId","data-v-b68b1667"]]);const Do={components:{AppHeader:bo,AppContent:vo,AppFooter:Po},created(){this.checkAuth()},methods:{checkAuth(){}}};function So(e,t,o,c,a,n){const u=C("AppHeader"),s=C("AppContent"),h=C("AppFooter");return i(),y(be,null,{default:r(()=>[l(u),l(_e,{class:"d-flex flex-column"},{default:r(()=>[l(s,{class:"flex-1-1"}),l(h,{class:"flex-0-0"})]),_:1})]),_:1})}const Mo=I(Do,[["render",So]]),Fo="modulepreload",Vo=function(e){return"/"+e},et={},me=function(t,o,c){if(!o||o.length===0)return t();const a=document.getElementsByTagName("link");return Promise.all(o.map(n=>{if(n=Vo(n),n in et)return;et[n]=!0;const u=n.endsWith(".css"),s=u?'[rel="stylesheet"]':"";if(!!c)for(let M=a.length-1;M>=0;M--){const E=a[M];if(E.href===n&&(!u||E.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${s}`))return;const g=document.createElement("link");if(g.rel=u?"stylesheet":Fo,u||(g.as="script",g.crossOrigin=""),g.href=n,document.head.appendChild(g),u)return new Promise((M,E)=>{g.addEventListener("load",M),g.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>t()).catch(n=>{const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=n,window.dispatchEvent(u),!u.defaultPrevented)throw n})},we={LOGIN:"/Login"},xo=[{path:we.LOGIN,name:"Login",component:()=>me(()=>Promise.resolve().then(()=>jo),void 0)},{path:"/Tool",name:"Tool",component:()=>me(()=>Promise.resolve().then(()=>Br),void 0)},{path:"/QR-code",name:"QR-code",component:()=>me(()=>Promise.resolve().then(()=>jr),void 0)},{path:"/",redirect:"/Tool"},{path:"/:catchAll(.*)",name:"Error404",component:()=>me(()=>Promise.resolve().then(()=>Xr),void 0)}],dt=Tt({history:kt(),routes:xo});dt.beforeEach((e,t,o)=>{const c=!!localStorage.getItem("token");!c&&e.path!==we.LOGIN?o({path:we.LOGIN}):c&&e.path===we.LOGIN?o({path:"/"}):o()});async function Oo(){(await me(()=>import("./vendor-9614aa36.js").then(t=>t.w),["assets/vendor-9614aa36.js","assets/vendor-3f4f1faa.css"])).load({google:{families:["Roboto:100,300,400,500,700,900&display=swap"]}})}const ze=localStorage.getItem("theme"),Ao=ze==="dark"||!ze&&window.matchMedia("(prefers-color-scheme: dark)").matches,Eo={...It},Bo=vt({lang:{locales:{ru:Eo},current:"ru"},theme:{defaultTheme:ze||(Ao?"dark":"light"),themes:{light:{colors:{primary:"#1867C0",secondary:"#5CBBF6"}},dark:{dark:!0,variables:{},colors:{primary:"#1867C0",secondary:"#5CBBF6"}}}}});function Lo(e){Oo(),e.use(Bo)}const ke=Ct(Mo),Uo=wt();ke.use(Uo);Lo(ke);ke.use(dt);ke.use(fe);ke.mount("#app");const Ho="/assets/logo_min-4d11d442.png",Ro={data:()=>({login:"",password:"",visible:!1,isAuthorized:!1,showError:!1,errorMessage:"",formValid:!1,loginRules:[e=>!!e||"Логин обязателен"],passwordRules:[e=>!!e||"Пароль обязателен"]}),created(){this.isAuthorized=!!localStorage.getItem("token")},methods:{...R("authStore",["setAuthorization","setUserRole"]),toggleVisibility(){this.visible=!this.visible},async submit(){if(await this.$refs.form.validate(),!!this.formValid)try{const e=await D.post("/login",{login:this.login,password:this.password});e.data.status==="ok"?(localStorage.setItem("token",e.data.token),this.$router.push("/")):(this.showError=!0,this.errorMessage="Неправильный логин или пароль")}catch(e){this.showError=!0,this.errorMessage="Ошибка авторизации",console.error("Login error:",e)}}}},No=d("h1",{class:"text-h4 text-center pb-6"},"Авторизация",-1),zo=d("div",{class:"text-subtitle-1 text-medium-emphasis"},"Логин",-1),$o=d("div",{class:"text-subtitle-1 text-medium-emphasis d-flex align-center justify-space-between"}," Пароль ",-1);function Go(e,t,o,c,a,n){return i(),m("div",null,[l(V,null,{default:r(()=>[l(Pt,{class:"mx-auto my-6","max-width":"100",src:Ho}),No,e.isAuthorized?_("",!0):(i(),y(ge,{key:0,class:"mx-auto pa-12 pb-8",elevation:"8","max-width":"448",rounded:"lg"},{default:r(()=>[l(Dt,{ref:"form",modelValue:e.formValid,"onUpdate:modelValue":t[3]||(t[3]=u=>e.formValid=u)},{default:r(()=>[zo,l(F,{modelValue:e.login,"onUpdate:modelValue":t[0]||(t[0]=u=>e.login=u),density:"compact",placeholder:"Login","prepend-inner-icon":"mdi-key",variant:"outlined",rules:e.loginRules},null,8,["modelValue","rules"]),$o,l(F,{modelValue:e.password,"onUpdate:modelValue":t[1]||(t[1]=u=>e.password=u),"append-inner-icon":e.visible?"mdi-eye-off":"mdi-eye",type:e.visible?"text":"password",density:"compact",placeholder:"Password","prepend-inner-icon":"mdi-lock-outline",variant:"outlined",rules:e.passwordRules,"onClick:appendInner":n.toggleVisibility},null,8,["modelValue","append-inner-icon","type","rules","onClick:appendInner"]),l(k,{disabled:!e.formValid,block:"",class:"mb-8",color:"blue",size:"large",variant:"tonal",onClick:n.submit},{default:r(()=>[f("Войти")]),_:1},8,["disabled","onClick"]),e.showError?(i(),y(St,{key:0,type:"error",dismissible:"",onClick:t[2]||(t[2]=u=>e.showError=!1)},{default:r(()=>[f(p(e.errorMessage),1)]),_:1})):_("",!0)]),_:1},8,["modelValue"])]),_:1}))]),_:1})])}const qo=I(Ro,[["render",Go]]),jo=Object.freeze(Object.defineProperty({__proto__:null,default:qo},Symbol.toStringTag,{value:"Module"})),oe=te.create({baseURL:"http://192.168.0.11:4000/api"});function le(e){return e.data}const X={fetchHistoryByPartId:async(e,t)=>oe.get("/history-part",{params:{id_part:e,selectedDate:t}}).then(le).catch(T),fetchHistoryByPartIdInfo:async(e,t)=>oe.get("/history-part/info",{params:{id_part:e,selectedDate:t}}).then(le).catch(T),fetchToolHistory:async(e="",t=1,o=100,c="",a="",n=!1)=>{const u={search:e,page:t,limit:o,date:c,toolId:a,showArchive:n};return oe.get("/history",{params:u}).then(le).catch(T)},cancelOperation:async(e,t,o)=>oe.post(`/issue/cancel-operation/${e}`,{issueToken:t,cancelQuantity:o}).then(le).catch(T),getAllIssuedToolIdsWithNames:async()=>oe.get("history-all-tool").then(le).catch(T),addToArchive:async(e,t,o)=>oe.post("/history-add-archive",{id_part:e,archive:t,token:o}).then(le).catch(T)};const Qo={name:"HistoryModal",components:{Modal:G},props:{idPart:{type:Number,default:null},selectedDate:{type:String,default:""},selectedTool:{type:Object,default:()=>({})}},emits:["canceled","operation-cancelled"],data(){return{showErrorSnackbar:!1,errorMessage:"",info:{is_archive:!1},userRole:null,showCancelDialog:!1,cancelQuantity:1,selectedOperationQuantity:100,operations:[],completedOperations:[],originalData:[],selectedOperation:"all",availableOperations:[],headers:[{title:"Инструмент",value:"name_tool"},{title:"Кол-во выдано",value:"quantity",width:"90px"},{title:"Сейчас склад",value:"current_stock"},{title:"Выдано",value:"user_fio"},{title:"Тип выдачи",value:"type_issue"},{title:"Дата время",value:"timestamp"},{title:"Тип",value:"type_oper"},{title:"Выдал",value:"issuer_fio"},{title:"Отмена",value:"cancelled"}],filteredData:[]}},computed:{popupTitle(){return this.info?`${this.info.name} ${this.info.description} (партия ${this.idPart})`:"Информация о партии"},currentHeaders(){return this.selectedOperation==="all"?this.headersAll:this.headers},headersAll(){return[{title:"Инструмент",value:"name_tool"},{title:"Дата первой выдачи",value:"timestamp"},{title:"Кол-во",value:"quantity",width:"90px"}]}},created(){this.fetchHistoryData(),this.checkLogin()},methods:{async checkLogin(){const e=localStorage.getItem("token");try{const t=await ye.checkLogin(e);t.status==="ok"&&(this.userRole=t.role)}catch(t){console.error("Ошибка при проверке логина:",t)}},async toggleArchiveStatus(){const e=this.info.is_archive,t=localStorage.getItem("token");try{await X.addToArchive(this.idPart,e,t),alert(`Статус архива для idPart ${this.idPart} успешно обновлен.`),await this.fetchHistoryData()}catch(o){console.error("Ошибка при изменении статуса архива:",o),alert("Произошла ошибка при изменении статуса архива.")}},promptCancelQuantity(e){this.currentOperationId=e,this.showCancelDialog=!0},async confirmCancelOperation(){this.showCancelDialog=!1,await this.cancelOperation(this.currentOperationId)},async cancelOperation(e){if(!e){console.error("Invalid operation ID:",e),this.errorMessage="Internal error: The operation ID is invalid.",this.showErrorSnackbar=!0;return}if(!confirm(`Вы уверены, что хотите отменить ${this.cancelQuantity} из этой операции?`))return;const t=localStorage.getItem("token");if(!t){console.error("Token not found in local storage."),this.errorMessage="Ошибка авторизации: Токен не найден.",this.showErrorSnackbar=!0;return}try{const o=await X.cancelOperation(e,t,this.cancelQuantity);if(o.success){const c=this.filteredData.find(a=>a.id===e);c&&(c.cancelled=!0,c.canceller_login=o.canceller_login),this.errorMessage="Операция успешно отменена",this.showErrorSnackbar=!0,this.$emit("operation-cancelled",e),await this.fetchHistoryData()}else this.errorMessage="Не удалось отменить операцию: "+(o.message||"Неизвестная ошибка"),this.showErrorSnackbar=!0}catch(o){console.error("Ошибка при отмене операции:",o),o.response&&o.response.status===403?this.errorMessage=o.response.data.message||"Отмена операции запрещена.":this.errorMessage="Ошибка при отмене операции: "+(o.message||"Неизвестная ошибка"),this.showErrorSnackbar=!0}},filterData(){this.selectedOperation==="all"?this.filteredData=this.originalData.all||[]:this.filteredData=this.originalData[this.selectedOperation]||[]},formatDate(e){try{return z(Q(e),"dd.MM.yy HH:mm:ss")}catch(t){return console.error("Error formatting date:",t),"Invalid Date"}},onCancel(){this.$emit("canceled")},async fetchHistoryData(){try{const e=await X.fetchHistoryByPartId(this.idPart,this.selectedDate),t=await X.fetchHistoryByPartIdInfo(this.idPart);this.operations=t.info.operations,this.completedOperations=t.info.completed_operations,e&&typeof e=="object"?(this.info=t.info,this.originalData=e,this.availableOperations=Object.keys(this.originalData).filter(o=>o!=="info"),this.filterData()):(this.filteredData=[],this.availableOperations=["all"])}catch(e){console.error("Error fetching history data:",e)}}}},Zo={style:{"padding-left":"16px"}},Wo=d("th",null,"#",-1),Ko={class:"grey"},Jo={key:1};function Xo(e,t,o,c,a,n){const u=C("Modal",!0);return i(),y(u,{title:n.popupTitle,"width-default":"1450px"},{content:r(()=>[d("div",Zo,[l(S,null,{default:r(()=>[d("div",null,[l(S,{align:"center",class:"ml-3 py-4"},{default:r(()=>[l(v,{cols:"auto",class:"d-flex align-center"},{default:r(()=>{var s;return[(s=a.info)!=null&&s.is_archive?(i(),y(w,{key:0,icon:"mdi-archive check-icon--large--gray",class:"mr-2",title:"В архиве"})):_("",!0)]}),_:1}),l(v,{class:"d-flex align-center"},{default:r(()=>[l(k,{color:"blue darken-1",variant:"text",class:"text-none text-subtitle-1 mr-4",onClick:n.fetchHistoryData},{default:r(()=>[f(" Обновить ")]),_:1},8,["onClick"]),a.userRole==="Editor"||a.userRole==="Admin"?(i(),y(Te,{key:0,modelValue:a.info.is_archive,"onUpdate:modelValue":t[0]||(t[0]=s=>a.info.is_archive=s),label:"Архив",onChange:n.toggleArchiveStatus},null,8,["modelValue","onChange"])):_("",!0)]),_:1})]),_:1}),l(v,{cols:"12",class:"my-2"},{default:r(()=>[d("div",null,[f(" Прогресс: "),(i(!0),m(b,null,P(a.operations,s=>(i(),y(O,{key:s+"progress",color:a.completedOperations.includes(s)?"green":"grey",variant:a.completedOperations.includes(s)?"elevated":"text",class:"ma-2",outlined:""},{default:r(()=>[f(p(s),1)]),_:2},1032,["color","variant"]))),128))])]),_:1})]),l(x),l(v,{cols:"12",md:"3"},{default:r(()=>[l(W,{modelValue:a.selectedOperation,"onUpdate:modelValue":[t[1]||(t[1]=s=>a.selectedOperation=s),n.filterData],label:"Операция",items:a.availableOperations,solo:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),l(H,{hover:"",class:"elevation-1"},{default:r(()=>[d("thead",null,[d("tr",null,[Wo,(i(!0),m(b,null,P(n.currentHeaders,s=>(i(),m("th",{key:s.value,class:"text-left"},p(s.title),1))),128))])]),d("tbody",null,[(i(!0),m(b,null,P(a.filteredData,(s,h)=>(i(),m("tr",{key:s.id,class:A({"bg-blue-darken-2":s.type==="sum"})},[d("td",Ko,p(h+1),1),(i(!0),m(b,null,P(n.currentHeaders,g=>(i(),m("td",{key:g.value},[g.value==="name_tool"&&s&&o.selectedTool&&s.id_tool===o.selectedTool.id_tool?(i(),m(b,{key:0},[s.id_tool===o.selectedTool.id_tool?(i(),y(O,{key:0,color:"green",size:"large","text-color":"white"},{default:r(()=>[f(p(s[g.value]),1)]),_:2},1024)):(i(),m("span",Jo,p(s[g.value]),1))],64)):g.value==="cancelled"?(i(),m(b,{key:1},[s.cancelled?(i(),m(b,{key:0},[f(p(s.canceller_login),1)],64)):(i(),y(k,{key:1,variant:"tonal",size:"x-small",icon:"",small:"",color:"error",onClick:ie(M=>n.promptCancelQuantity(s.id),["stop"])},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-close")]),_:1})]),_:2},1032,["onClick"]))],64)):g.value==="timestamp"?(i(),m(b,{key:2},[f(p(n.formatDate(s[g.value])),1)],64)):(i(),m(b,{key:3},[f(p(s[g.value]),1)],64))]))),128))],2))),128))])]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"])]),default:r(()=>[l($e,{modelValue:a.showCancelDialog,"onUpdate:modelValue":t[4]||(t[4]=s=>a.showCancelDialog=s),persistent:"","max-width":"350"},{default:r(()=>[l(ge,null,{default:r(()=>[l(qe,{class:"headline"},{default:r(()=>[f("Подтверждение отмены")]),_:1}),l(Ke,null,{default:r(()=>[f(" Введите для отмены: "),l(F,{modelValue:a.cancelQuantity,"onUpdate:modelValue":t[2]||(t[2]=s=>a.cancelQuantity=s),type:"number",label:"Количество",rules:[s=>s>0||"Введите положительное число"]},null,8,["modelValue","rules"])]),_:1}),l(je,null,{default:r(()=>[l(x),l(k,{color:"green darken-1",text:"true",onClick:n.confirmCancelOperation},{default:r(()=>[f(" Подтвердить ")]),_:1},8,["onClick"]),l(k,{color:"red darken-1",text:"true",onClick:t[3]||(t[3]=s=>a.showCancelDialog=!1)},{default:r(()=>[f(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(de,{modelValue:a.showErrorSnackbar,"onUpdate:modelValue":t[5]||(t[5]=s=>a.showErrorSnackbar=s),color:"error",timeout:15e3},{default:r(()=>[f(p(a.errorMessage),1)]),_:1},8,["modelValue"])]),_:1},8,["title"])}const Yo=I(Qo,[["render",Xo]]);const el={components:{EditToolModal:Yo},emits:["error"],data(){return{toolOptions:[],selectedTool:null,searchQuery:"",selectedDate:"",dateOptions:this.generateDateOptions(),date:"",debouncedFetchAndFormatToolHistory:null,openDialog:!1,filters:{itemsPerPage:15,currentPage:1},isLoading:!1,showModal:!1,toolsHistory:[],editingToolId:null,totalCount:0,showArchive:!1,headers:[{title:"",value:"check",sortable:!1},{title:"Партия",value:"id_part",sortable:!1},{title:"Название",value:"name",sortable:!1,width:"300px"},{title:"Обозначение",value:"description",sortable:!1},{title:"Дата первой выдачи",value:"first_issue_date",sortable:!1},{title:"Выдано инструмента",value:"quantity_tool",sortable:!1,width:"80px"},{title:"Готовность операций",value:"operation_status",sortable:!1},{title:"Произведено / План",value:"quantity_prod_all",sortable:!1,width:"180px"}]}},watch:{searchQuery(e,t){e!==t&&this.debouncedFetchAndFormatToolHistory()}},async mounted(){this.toolOptions=await X.getAllIssuedToolIdsWithNames(),await this.fetchAndFormatToolHistory()},created(){this.dateOptions=this.generateDateOptions(),this.debouncedFetchAndFormatToolHistory=this.debounce(this.fetchAndFormatToolHistory,500)},methods:{generateDateOptions(){const e=[{value:"",title:"ВСЕ"}],t=new Date;t.setHours(0,0,0,0);for(let o=0;o<90;o++){const c=new Date(t);c.setDate(t.getDate()-o);const a=new Date(c.getTime()+180*6e4),n=a.toISOString().substring(0,10),u=a.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"}),s=o===0?" - СЕГОДНЯ":o===1?" - ВЧЕРА":"";e.push({value:n,title:`${u}${s}`})}return e},debounce(e,t){let o;return function(...c){clearTimeout(o),o=setTimeout(()=>{e.apply(this,c)},t)}},async onChangePage(e){this.filters.currentPage=e,await this.fetchAndFormatToolHistory()},async onUpdateItemsPerPage(e){this.filters.itemsPerPage=e,await this.fetchAndFormatToolHistory()},formatDate(e){return z(Q(e),"dd.MM.yy")},async fetchAndFormatToolHistory(){this.isLoading=!0;try{let e=await X.fetchToolHistory(this.searchQuery,this.filters.currentPage,this.filters.itemsPerPage,this.selectedDate?this.selectedDate:null,this.selectedTool?this.selectedTool.id_tool:null,this.showArchive);this.toolsHistory=e.toolsHistory.map(t=>({...t,first_issue_date:this.formatDate(t.first_issue_date)})),this.totalCount=e.totalCount}catch(e){console.error("Ошибка при получении истории инструментов:",e),this.$emit("error",e)}finally{this.isLoading=!1}},onClosePopup(){this.openDialog=!1,this.fetchAndFormatToolHistory()},onInfoRow(e,{item:t}){this.editingToolId=t.id_part,this.openDialog=!0},onSaveChanges(){this.fetchAndFormatToolHistory(),this.openDialog=!1},async updateArchiveStatus(e,t){try{await X.updateArchiveStatus(e,t),await this.fetchAndFormatToolHistory()}catch(o){console.error("Ошибка при обновлении статуса архива:",o),this.$emit("error",o)}}}},tl={class:"d-flex align-center justify-center"},ol={key:0,class:"mdi mdi-archive check-icon--large--gray",title:"В архиве"},ll={key:1,class:"mdi mdi-help check-icon--large--red",title:"Отгружено, не все операции завершены, не в производстве"},al={key:2,class:"mdi mdi-truck-check check-icon--large--green",title:"Отгружено"},sl={key:3,class:"mdi mdi-check check-icon--large--green",title:"Произведено"},rl={key:4,class:"mdi mdi-stop check-icon--large--yellow",title:"Не в производстве"};function nl(e,t,o,c,a,n){const u=C("edit-tool-modal");return i(),y(V,null,{default:r(()=>[a.openDialog?(i(),y(u,{key:0,persistent:!0,"id-part":a.editingToolId,"selected-date":a.selectedDate,"selected-tool":a.selectedTool,onCanceled:n.onClosePopup,onChangesSaved:n.fetchAndFormatToolHistory,onClose:n.onClosePopup},null,8,["id-part","selected-date","selected-tool","onCanceled","onChangesSaved","onClose"])):_("",!0),d("div",tl,[l(S,{class:"fill-height"},{default:r(()=>[l(v,{cols:"12",md:"4",class:"d-flex align-center"},{default:r(()=>[l(F,{modelValue:a.searchQuery,"onUpdate:modelValue":t[0]||(t[0]=s=>a.searchQuery=s),variant:"outlined",clearable:"",label:"Поиск по партии, названию, обозначению",class:"flex-grow-1 mr-2","prepend-inner-icon":"mdi-magnify",onInput:a.debouncedFetchAndFormatToolHistory},null,8,["modelValue","onInput"])]),_:1}),l(v,{cols:"12",md:"4"},{default:r(()=>[l(L,{modelValue:a.selectedTool,"onUpdate:modelValue":[t[1]||(t[1]=s=>a.selectedTool=s),n.fetchAndFormatToolHistory],clearable:"true",items:a.toolOptions,"item-value":"id_tool","item-title":"name",label:"Выберите инструмент","prepend-inner-icon":"mdi-box-cutter"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),l(v,{cols:"12",md:"4"},{default:r(()=>[l(W,{modelValue:a.selectedDate,"onUpdate:modelValue":[t[2]||(t[2]=s=>a.selectedDate=s),n.fetchAndFormatToolHistory],clearable:"",items:a.dateOptions,"item-value":"value","item-title":"title",label:"Выберите дату","prepend-inner-icon":"mdi-calendar"},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1}),l(v,{cols:"12",md:"2",class:"d-flex align-center"},{default:r(()=>[l(Te,{modelValue:a.showArchive,"onUpdate:modelValue":t[3]||(t[3]=s=>a.showArchive=s),label:"Показать архив","hide-details":"",onChange:n.fetchAndFormatToolHistory},null,8,["modelValue","onChange"])]),_:1})]),_:1})]),a.toolsHistory&&a.toolsHistory.length>0?(i(),y(ce,{key:1,class:"scrollable-table","no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.headers,"items-length":a.totalCount,items:a.toolsHistory,"items-per-page":a.filters.itemsPerPage,page:a.filters.currentPage,loading:a.isLoading,"items-per-page-options":[15,50,100,300],hover:"","fixed-header":"",width:"true","onUpdate:page":n.onChangePage,"onUpdate:itemsPerPage":n.onUpdateItemsPerPage,"onClick:row":n.onInfoRow},{"item.id_part":r(({item:s})=>[d("td",{class:A({"item-in-archive":s.is_archive})},p(s.id_part),3)]),"item.name":r(({item:s})=>[d("td",{class:A({"item-in-archive":s.is_archive})},p(s.name),3)]),"item.description":r(({item:s})=>[d("td",{class:A({"item-in-archive":s.is_archive})},p(s.description),3)]),"item.first_issue_date":r(({item:s})=>[d("td",{class:A({"item-in-archive":s.is_archive})},p(s.first_issue_date),3)]),"item.check":r(({item:s})=>[s.is_archive?(i(),m("span",ol)):s.status_otgruzka&&s.ready_count<s.operation_count?(i(),m("span",ll)):s.status_otgruzka?(i(),m("span",al)):s.quantity_prod>=s.quantity_prod_all&&s.status_ready?(i(),m("span",sl)):s.status_ready?(i(),m("span",rl)):_("",!0)]),"item.operation_status":r(({item:s})=>[f(p(s.ready_count)+" / "+p(s.operation_count),1)]),"item.quantity_prod_all":r(({item:s})=>[f(p(s.quantity_prod)+" / "+p(s.quantity_prod_all),1)]),_:1},8,["headers","items-length","items","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage","onClick:row"])):_("",!0)]),_:1})}const il=I(el,[["render",nl]]),He=te.create({baseURL:"http://192.168.0.11:4000/api"});function Re(e){return e.data}const ct={fetchHistoryByPartId:async e=>He.get("/history-part",{params:{id_part:e}}).then(Re).catch(T),fetchToolHistory:async(e="",t=1,o=100,c=!1,a=null)=>{const n={search:e,page:t,limit:o,includeNull:c};return a!==null&&(n.parent_id=a),He.get("/history",{params:n}).then(Re).catch(T)},cancelOperation:async(e,t,o)=>He.post(`/issue/cancel-operation/${e}`,{issueToken:t,cancelQuantity:o}).then(Re).catch(T)},dl={name:"HistoryModal",components:{Modal:G},props:{idPart:{type:Number,default:null}},emits:["canceled","operation-cancelled"],data(){return{info:null,originalData:[],selectedOperation:"all",availableOperations:[],headers:[{title:"Инструмент",value:"name_tool"},{title:"Кол-во",value:"quantity",width:"90px"},{title:"Выдано",value:"user_fio"},{title:"Дата",value:"date"},{title:"Операция",value:"no_oper"},{title:"Тип",value:"type_oper"}],headersAll:[{title:"Инструмент",value:"name_tool"},{title:"Дата начальная",value:"date"},{title:"Кол-во",value:"quantity",width:"90px"}],filteredData:[],showOperationModal:!1,currentNoOper:null}},computed:{popupTitle(){return`Инструмент затраченный на партию: ${this.id_part}`},currentHeaders(){return this.selectedOperation==="all"?this.headersAll:this.headers}},created(){this.fetchHistoryData()},methods:{filterData(){this.filteredData=this.selectedOperation==="all"?this.originalData.all||[]:this.originalData[this.selectedOperation]||[]},formatDate(e){try{return z(Q(e),"dd.MM.yy HH:mm:ss")}catch(t){return console.error("Error formatting date:",t,"Date:",e),"Invalid Date"}},onCancel(){this.$emit("canceled")},async fetchHistoryData(){try{const e=await ct.fetchHistoryByPartId(this.id_part);if(this.info=e.info,e&&typeof e=="object"){const{...t}=e;this.originalData=t,this.filteredData=t.all||[],this.availableOperations=Object.keys(t)}else this.originalData={},this.filteredData=[],this.availableOperations=["all"]}catch(e){console.error("Error fetching history data:",e)}}}},cl={style:{"padding-left":"16px"}},ul={key:0,style:{"padding-left":"25px"}};function hl(e,t,o,c,a,n){const u=C("Modal",!0);return i(),y(u,{title:n.popupTitle,"width-default":"1300px"},{content:r(()=>[d("div",cl,[l(S,null,{default:r(()=>[a.info?(i(),m("h2",ul,p(a.info.name)+" "+p(a.info.description),1)):_("",!0),l(x),l(v,{cols:"12",md:"3"},{default:r(()=>[l(W,{modelValue:a.selectedOperation,"onUpdate:modelValue":[t[0]||(t[0]=s=>a.selectedOperation=s),n.filterData],label:"Операция",items:a.availableOperations,solo:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),l(H,{class:"elevation-1"},{default:r(()=>[d("thead",null,[d("tr",null,[(i(!0),m(b,null,P(n.currentHeaders,s=>(i(),m("th",{key:s.value,class:"text-left"},p(s.title),1))),128))])]),d("tbody",null,[(i(!0),m(b,null,P(a.filteredData,s=>(i(),m("tr",{key:s.id,class:A({"bg-blue-darken-2":s.type==="sum"})},[(i(!0),m(b,null,P(n.currentHeaders,h=>(i(),m("td",{key:h.value},[h.value==="date"?(i(),m(b,{key:0},[f(p(n.formatDate(s[h.value])),1)],64)):(i(),m(b,{key:1},[f(p(s[h.value]),1)],64))]))),128))],2))),128))])]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"])]),_:1},8,["title"])}const ml=I(dl,[["render",hl]]),pl=te.create({baseURL:"http://192.168.0.11:4000/api"});function fl(e){return e.data}const yl={fetchDamagedHistory:async()=>pl.get("/damaged-history").then(fl).catch(T)};const gl={components:{EditToolModal:ml},emits:["changes-saved"],data(){return{openDialog:!1,filters:{itemsPerPage:15,currentPage:1},isLoading:!1,showModal:!1,toolsHistory:[],editingToolId:null,totalCount:0,headers:[{title:"Название инструмента",value:"tool_name",sortable:!1,width:"200px"},{title:"ФИО",value:"user_name",sortable:!1,width:"320px"},{title:"Станок",value:"cnc_name",sortable:!1,width:"200px"},{title:"Комментарий",value:"comment",sortable:!1},{title:"Кол-во",key:"quantity",sortable:!1,width:"80px"},{title:"Дата",key:"timestamp",sortable:!1,width:"150px"}]}},async mounted(){await this.fetchAndFormatToolHistory()},methods:{async onChangePage(e){this.filters.currentPage=e,await this.fetchAndFormatToolHistory()},async onUpdateItemsPerPage(e){this.filters.itemsPerPage=e,await this.fetchAndFormatToolHistory()},formatDate(e){return z(Q(e),"dd.MM.yy hh:mm")},async fetchAndFormatToolHistory(){try{const e=await yl.fetchDamagedHistory("",this.filters.currentPage,this.filters.itemsPerPage);this.toolsHistory=e.toolsHistory.map(t=>({...t,timestamp:t.timestamp?this.formatDate(t.timestamp):null})),this.totalCount=e.totalCount}catch(e){console.error("Error fetching tool history:",e)}},onClosePopup(){this.openDialog=!1},onInfoRow(e,{item:t}){this.editingToolId=t.id_part,this.openDialog=!0},onSaveChanges(){this.openDialog=!1,this.$emit("changes-saved")}}};function _l(e,t,o,c,a,n){const u=C("edit-tool-modal");return i(),y(V,null,{default:r(()=>[a.openDialog?(i(),y(u,{key:0,persistent:!0,id_part:a.editingToolId,onCanceled:n.onClosePopup,onChangesSaved:n.onSaveChanges},null,8,["id_part","onCanceled","onChangesSaved"])):_("",!0),a.toolsHistory&&a.toolsHistory.length>0?(i(),y(ce,{key:1,"no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.headers,"items-length":a.totalCount,items:a.toolsHistory,"items-per-page":a.filters.itemsPerPage,page:a.filters.currentPage,loading:a.isLoading,"items-per-page-options":[15,50,100,300],hover:"","fixed-header":"",width:"true",class:"scrollable-table","onUpdate:page":n.onChangePage,"onUpdate:itemsPerPage":n.onUpdateItemsPerPage},null,8,["headers","items-length","items","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage"])):_("",!0)]),_:1})}const bl=I(gl,[["render",_l]]);function ve(e){return e.data}const Ie={updateToolParam:async(e,t)=>D.put(`/tools-params/${e}`,t).then(ve).catch(T),deleteToolParam:async e=>D.delete(`/tools-params/${e}`).then(ve).catch(T),addToolParam:async e=>D.post("/tools-params",e).then(ve).catch(T),moveToolParam:async(e,t)=>D.patch(`/tools-params/${e}/move`,{action:t}).then(ve).catch(T)},Tl={data(){return{toolParams:[],showDialog:!1,dialogTitle:"",paramInfo:"",editingParam:null}},mounted(){this.getData()},methods:{async getData(){try{this.toolParams=await xe()}catch(e){console.error("Error fetching data:",e)}},startAdding(){this.dialogTitle="Новый параметр",this.paramInfo="",this.editingParam=null,this.showDialog=!0},startEditing(e){this.dialogTitle="Редактировать название параметра",this.paramInfo=e.label,this.editingParam=e,this.showDialog=!0},async saveParam(){if(this.paramInfo){const e=this.paramInfo;if(this.toolParams.some(t=>{var o;return t.label.toLowerCase()===e.toLowerCase()&&t.id!==((o=this.editingParam)==null?void 0:o.id)})){alert("Такой параметр уже существует");return}try{if(this.editingParam){const t={label:e};await Ie.updateToolParam(this.editingParam.id,t)&&(this.toolParams=this.toolParams.map(c=>c.id===this.editingParam.id?{...c,label:e}:c))}else{const t=await Ie.addToolParam({label:e});if(t&&t.id)this.toolParams.push(t);else throw new Error("Failed to retrieve new param data")}}catch(t){console.error("Error saving tool parameter:",t)}this.paramInfo="",this.showDialog=!1,this.editingParam=null}else alert("Пожалуйста, введите информацию для инструмента")},async deleteParam(e){if(confirm(`Вы уверены, что хотите удалить параметр: ${e.label}?`))try{await Ie.deleteToolParam(e.id);const o=this.toolParams.indexOf(e);o>-1&&this.toolParams.splice(o,1)}catch(o){console.error("Error deleting tool parameter:",o)}},async moveToolParam(e,t){try{if(await Ie.moveToolParam(e,t),t==="moveUp"){const o=this.toolParams.findIndex(c=>c.id===e);o>0&&([this.toolParams[o],this.toolParams[o-1]]=[this.toolParams[o-1],this.toolParams[o]])}else if(t==="moveDown"){const o=this.toolParams.findIndex(c=>c.id===e);o<this.toolParams.length-1&&([this.toolParams[o],this.toolParams[o+1]]=[this.toolParams[o+1],this.toolParams[o]])}}catch(o){console.error("Error moving tool parameter:",o)}}}},kl={class:"d-flex"},vl=d("h2",{class:"text-h5"},"Параметры Инструмента",-1),Il=d("thead",null,[d("tr",null,[d("th",{class:"text-left"},"№"),d("th",{class:"text-left"},"Название"),d("th",{class:"text-left"},"Порядок"),d("th",{class:"text-left"},"Действия")])],-1);function Cl(e,t,o,c,a,n){return i(),y(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[d("div",kl,[vl,l(x),l(k,{color:"primary",onClick:n.startAdding},{default:r(()=>[l(w,{left:""},{default:r(()=>[f("mdi-playlist-plus")]),_:1}),f(" Добавить параметр ")]),_:1},8,["onClick"])]),l($e,{modelValue:a.showDialog,"onUpdate:modelValue":t[2]||(t[2]=u=>a.showDialog=u),persistent:"","max-width":"600px"},{default:r(()=>[l(ge,null,{default:r(()=>[l(qe,null,{default:r(()=>[f(p(a.dialogTitle),1)]),_:1}),l(Ke,null,{default:r(()=>[l(F,{modelValue:a.paramInfo,"onUpdate:modelValue":t[0]||(t[0]=u=>a.paramInfo=u),label:"Название",required:""},null,8,["modelValue"])]),_:1}),l(je,null,{default:r(()=>[l(x),l(k,{color:"blue darken-1",text:"",onClick:t[1]||(t[1]=u=>a.showDialog=!1)},{default:r(()=>[f(" Отмена ")]),_:1}),l(k,{color:"blue darken-1",text:"",onClick:n.saveParam},{default:r(()=>[f(" Сохранить ")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(H,{hover:""},{default:r(()=>[Il,d("tbody",null,[(i(!0),m(b,null,P(a.toolParams,(u,s)=>(i(),m("tr",{key:u.id},[d("td",null,p(s+1),1),d("td",null,p(u.label),1),d("td",null,[l(k,{icon:"",disabled:s===0,onClick:h=>n.moveToolParam(u.id,"moveUp")},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-chevron-up")]),_:1})]),_:2},1032,["disabled","onClick"]),l(k,{icon:"",disabled:s===a.toolParams.length-1,onClick:h=>n.moveToolParam(u.id,"moveDown")},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-chevron-down")]),_:1})]),_:2},1032,["disabled","onClick"])]),d("td",null,[l(k,{icon:"",onClick:h=>n.startEditing(u)},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-pencil")]),_:1})]),_:2},1032,["onClick"]),l(k,{icon:"",onClick:h=>n.deleteParam(u)},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-delete")]),_:1})]),_:2},1032,["onClick"])])]))),128))])]),_:1})]),_:1})]),_:1})]),_:1})}const wl=I(Tl,[["render",Cl]]);function Pl(e){return e.data}const Dl={getToolGroups:async()=>D.get("/tools-groups").then(Pl).catch(T)};function ue(e){return e.data}const he={addTool:async e=>D.post("/tool",e).then(ue).catch(T),deleteTool:async e=>D.delete(`/tool/${e}`).then(ue).catch(T),updateTool:async(e,t)=>D.put(`/tool/${e}`,t).then(ue).catch(T),getToolParamsByParentId:async e=>D.get(`/tools-params/${e}`).then(ue).catch(T),getToolNamesByParentId:async e=>D.get(`/tools-params-name/${e}`).then(ue).catch(T)},Sl={name:"FillingModal",components:{Modal:G},props:{persistent:{type:Boolean,default:!1},toolId:{type:Number,default:null}},emits:["canceled","changes-saved"],data(){return{snackbar:{show:!1,color:"error",text:""},toolModel:{name:null,property:{},group_id:null,group_standard:null,sklad:null,norma:null},toolNameOptions:[],parameterValuePairs:[{parameter:null,value:null}],toolParamOptions:[],toolParamsOptions:{},selectedParams:[],toolParams:[],confirmDeleteDialog:!1,typeSelected:!1,selectedType:"",parentIdRules:[e=>!!e||"ID папки обязательно",e=>e>1||"ID папки должен быть больше 1",e=>e!==""||"ID папки не должен быть пустым"],typeRules:[e=>!!e||"Поле обязательно для заполнения",e=>e&&e.length>=3||"Минимальная длина: 3 символа"]}},computed:{...U("EditorToolStore",["nameOptions","tool","parentCatalog"]),availableToolParamOptions(){return this.toolParamOptions.filter(e=>!this.selectedParams.includes(e))},isAddButtonVisible(){const e=new Set(Object.keys(this.toolModel.property)).size,t=this.toolParams.length;return e<t},selectedParamsInfo(){return Object.entries(this.toolModel.property).map(([e,t])=>{const o=this.toolParams.find(c=>c.id.toString()===e);return o?{...o,value:t}:null}).filter(e=>e!==null)},popupTitle(){var e;return((e=this.tool)==null?void 0:e.id)!=null?`Редактировать инструмент ID: ${this.tool.id}`:"Добавить новый инструмент"}},watch:{toolId:{immediate:!0,async handler(e){e==null?this.resetToolModel():(await this.fetchToolById(e),this.updateToolModel())}}},async created(){await this.fetchToolParamsByParentId(this.parentCatalog.id),await this.fetchToolNamesByParentId(this.parentCatalog.id);try{const e=await xe();if(this.toolParams=[...e],this.toolParamOptions=e.map(t=>t.info),this.toolModel.property&&Object.keys(this.toolModel.property).length>0){const t=Object.keys(this.toolModel.property);this.selectedParams=this.toolParams.filter(o=>t.includes(String(o.id))).map(o=>o.info)}}catch(e){console.error("Ошибка при загрузке параметров инструмента:",e)}this.toolId==null?this.setTool({id:null,name:null,property:{}}):(await this.fetchToolById(this.toolId),this.tool&&this.tool.property===null&&(this.tool.property={}))},methods:{...R("EditorToolStore",["fetchToolsByFilter","fetchToolById"]),...$("EditorToolStore",["setTool"]),showErrorSnackbar(e){this.snackbar.text=e,this.snackbar.color="error",this.snackbar.show=!0},async fetchToolNamesByParentId(e){try{this.toolNameOptions=await he.getToolNamesByParentId(e)}catch(t){console.error("Ошибка при получении названий инструментов:",t)}},async fetchToolParamsByParentId(e){try{const t=await he.getToolParamsByParentId(e);let o={};t.forEach(c=>{o[c.id]=c.values}),this.toolParamsOptions=o}catch(t){console.error("Ошибка при получении данных о параметрах:",t)}},removeParameter(e){window.confirm("Вы уверены, что хотите удалить этот параметр?")&&(delete this.toolModel.property[e],this.toolModel.property={...this.toolModel.property},this.updateSelectedParams())},selectParam(e){const t=this.toolParams.find(o=>o.info===e);if(t){const o={...this.toolModel.property};delete o[-1],o[t.id]=this.toolModel.property[-1]||"",this.toolModel.property=o,this.updateSelectedParams()}},updateSelectedParams(){this.selectedParams=Object.keys(this.toolModel.property).map(e=>{const t=this.toolParams.find(o=>String(o.id)===e);return t?t.info:null}).filter(e=>e!==null)},resetToolModel(){this.toolModel={name:null,limit:null,sklad:null,norma:null,property:{},group_id:0,group_standard:null}},addParameterValuePair(){if(!this.selectedParams.includes("-1")){const e={id:-1,info:null};this.toolParams.push(e),this.toolModel.property[e.id]=null,this.updateSelectedParams()}},updateToolModel(){this.tool&&(this.toolModel=JSON.parse(JSON.stringify(this.tool)))},confirmDelete(){window.confirm("Вы уверены, что хотите удалить этот инструмент?")&&this.onDelete()},async onDelete(){const{id:e}=this.toolModel;if(e!=null)try{(await he.deleteTool(e)).success==="OK"&&this.$emit("changes-saved")}catch(t){console.error("Ошибка при удалении инструмента:",t),this.showErrorSnackbar("Инструмент используется в истории.")}},onCancel(){this.$emit("canceled")},async onSave(){const e={...this.toolModel,parent_id:this.toolModel.parent_id};try{let t;this.toolId?t=await he.updateTool(this.toolId,e):t=await he.addTool(e),t.success==="OK"&&this.$emit("changes-saved")}catch(t){console.error("Ошибка при сохранении:",t.response?t.response.data:t)}}}},Ml=d("h2",{class:"text-h6"},"Характеристики:",-1);function Fl(e,t,o,c,a,n){const u=C("Modal",!0);return i(),m(b,null,[l(u,{title:n.popupTitle,"width-default":"650px"},{content:r(()=>[l(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"6"},{default:r(()=>[l(F,{modelValue:a.toolModel.folder_name,"onUpdate:modelValue":t[0]||(t[0]=s=>a.toolModel.folder_name=s),label:"Папка",variant:"solo",density:"compact",required:"",type:"Text",disabled:!0},null,8,["modelValue"])]),_:1}),l(v,{cols:"6"},{default:r(()=>[l(F,{variant:"solo",density:"compact",modelValue:a.toolModel.parent_id,"onUpdate:modelValue":t[1]||(t[1]=s=>a.toolModel.parent_id=s),label:"ID папки",required:"",type:"Number",rules:a.parentIdRules},null,8,["modelValue","rules"])]),_:1})]),_:1}),l(S,null,{default:r(()=>[l(v,{cols:"6",class:"pl-10"},{default:r(()=>[l(Te,{modelValue:a.toolModel.group_standard,"onUpdate:modelValue":t[2]||(t[2]=s=>a.toolModel.group_standard=s),label:"Эталон группы",color:"yellow"},null,8,["modelValue"])]),_:1}),l(v,{cols:"6"},{default:r(()=>[l(F,{modelValue:a.toolModel.group_id,"onUpdate:modelValue":t[3]||(t[3]=s=>a.toolModel.group_id=s),label:"ID группы",variant:"solo",density:"compact",required:"",type:"Number"},null,8,["modelValue"])]),_:1})]),_:1}),d("div",null,[l(L,{modelValue:a.toolModel.name,"onUpdate:modelValue":t[4]||(t[4]=s=>a.toolModel.name=s),variant:"outlined",label:"Маркировка",items:a.toolNameOptions,"item-text":"text","item-value":"value",required:"",rules:a.typeRules},null,8,["modelValue","items","rules"])]),Ml,(i(!0),m(b,null,P(n.selectedParamsInfo,(s,h)=>(i(),m("div",{key:s.id},[l(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"6",class:"pa-1"},{default:r(()=>[l(W,{modelValue:s.info,"onUpdate:modelValue":[g=>s.info=g,g=>n.selectParam(g,h)],variant:"solo-filled",density:"compact",items:n.availableToolParamOptions,label:"Параметр","single-line":"",solo:""},null,8,["modelValue","onUpdate:modelValue","items"])]),_:2},1024),l(v,{cols:"5",class:"pa-1"},{default:r(()=>[l(L,{modelValue:a.toolModel.property[s.id],"onUpdate:modelValue":g=>a.toolModel.property[s.id]=g,density:"compact",items:a.toolParamsOptions[s.id],label:"Значение",variant:"outlined",clearable:"","single-line":"",solo:""},null,8,["modelValue","onUpdate:modelValue","items"])]),_:2},1024),l(v,{cols:"1",class:"d-flex justify-end"},{default:r(()=>[l(k,{size:"small",icon:"",onClick:g=>n.removeParameter(s.id)},{default:r(()=>[l(w,null,{default:r(()=>[f("mdi-delete")]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),l(S,{justify:"center"},{default:r(()=>[l(v,{cols:"12",class:"text-center mb-4"},{default:r(()=>[at(l(k,{color:"primary",onClick:n.addParameterValuePair},{default:r(()=>[f(" Добавить ")]),_:1},8,["onClick"]),[[st,n.isAddButtonVisible]])]),_:1})]),_:1}),l(De,{class:"my-1"}),l(S,null,{default:r(()=>[l(v,{cols:"6"},{default:r(()=>[l(F,{disabled:a.toolModel.group_id&&!a.toolModel.group_standard,modelValue:a.toolModel.norma,"onUpdate:modelValue":t[5]||(t[5]=s=>a.toolModel.norma=s),type:"number",label:"Нормативный запас",required:""},null,8,["disabled","modelValue"])]),_:1}),l(v,{cols:"6"},{default:r(()=>[l(F,{modelValue:a.toolModel.sklad,"onUpdate:modelValue":t[6]||(t[6]=s=>a.toolModel.sklad=s),type:"number",label:"Склад",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.confirmDelete},{default:r(()=>[f(" Удалить ")]),_:1},8,["onClick"]),l(x),l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"]),l(k,{"prepend-icon":"mdi-check",class:"text-none text-subtitle-1 pl-3",color:"green",size:"large",variant:"flat",onClick:n.onSave},{default:r(()=>[f(" Сохранить ")]),_:1},8,["onClick"])]),_:1},8,["title"]),l(de,{modelValue:a.snackbar.show,"onUpdate:modelValue":t[8]||(t[8]=s=>a.snackbar.show=s),color:a.snackbar.color,bottom:"",right:""},{default:r(()=>[f(p(a.snackbar.text)+" ",1),l(k,{color:"white",text:"",onClick:t[7]||(t[7]=s=>a.snackbar.show=!1)},{default:r(()=>[f("Закрыть")]),_:1})]),_:1},8,["modelValue","color"])],64)}const Vl=I(Sl,[["render",Fl]]);const xl={components:{GroupsToolModal:Vl},data(){return{toolGroups:[],visibleGroups:[],colors:["red","green","blue","orange","purple","cyan"],editingToolId:null,openDialog:!1,isAllVisible:!1}},mounted(){this.fetchGroupsData()},computed:{totalForEachGroup(){let e=0;return{totalsForEachGroup:Object.keys(this.toolGroups).reduce((o,c)=>{const a=this.toolGroups[c].reduce((n,u)=>n+u.sklad,0);return e+=a,o[c]=a,o},{}),totalSum:e}}},methods:{modalSaved(){this.openDialog=!1,this.fetchGroupsData()},editTool(e){this.editingToolId=e,this.openDialog=!0},onClosePopup(){this.openDialog=!1},getColorForGroup(e){return`hsl(${e*137.508%360}, 50%, 50%)`},async fetchGroupsData(){try{this.toolGroups=await Dl.getToolGroups()}catch(e){console.error("Ошибка при получении данных: ",e)}},toggleVisibility(e){const t=this.visibleGroups.indexOf(e);t===-1?this.visibleGroups.push(e):this.visibleGroups.splice(t,1)},toggleAllVisibility(){this.isAllVisible=!this.isAllVisible,this.isAllVisible?this.visibleGroups=Object.keys(this.toolGroups):this.visibleGroups=[]}}},Ol={class:"d-flex justify-end"},Al={key:0,class:"pl-4 pr-2"},El=d("span",{class:"grey pl-4 pr-2"}," Склад группы: ",-1),Bl=d("span",{class:"grey pl-4 pr-2"},"Норма:",-1),Ll={key:1},Ul=d("span",{class:"red pl-4 pr-2"}," Не хватает: ",-1),Hl={key:1},Rl=d("thead",null,[d("tr",null,[d("th",{class:"text-left mw25"},"#"),d("th",{class:"text-left mw200"},"Инструмент"),d("th",{class:"text-left mw200"},"Расположение"),d("th",{class:"text-left mw25"},"Склад"),d("th",{class:"text-left mw25"},"Норма")])],-1),Nl=["onClick"],zl={class:"grey"},$l={key:0,style:{color:"yellow"}};function Gl(e,t,o,c,a,n){const u=C("groups-tool-modal");return i(),m(b,null,[a.openDialog?(i(),y(u,{key:0,persistent:!0,"tool-id":a.editingToolId,onCanceled:n.onClosePopup,onChangesSaved:n.modalSaved},null,8,["tool-id","onCanceled","onChangesSaved"])):_("",!0),d("div",null,[d("div",Ol,[l(k,{variant:"text",onClick:n.toggleAllVisibility},{default:r(()=>[f(p(a.isAllVisible?"Свернуть все":"Развернуть все"),1)]),_:1},8,["onClick"])]),(i(!0),m(b,null,P(a.toolGroups,(s,h)=>(i(),m("div",{key:h,class:"tool-group"},[s[0].group_id?(i(),y(O,{key:0,color:n.getColorForGroup(s[0].group_id),title:"Группа "+s[0].group_id},{default:r(()=>[f(" G"+p(s[0].group_id),1)]),_:2},1032,["color","title"])):_("",!0),l(O,{variant:"text",size:"large",onClick:g=>n.toggleVisibility(h)},{default:r(()=>[f(p(s[0].name)+" ",1),s[0].group_standard?_("",!0):(i(),m("span",Al," (Эталон не установлен) ")),El,f(" "+p(n.totalForEachGroup.totalsForEachGroup[s[0].group_id])+" ",1),Bl,f(" "+p(s[0].norma)+" ",1),s[0].norma-n.totalForEachGroup.totalsForEachGroup[s[0].group_id]>0?(i(),m("div",Ll,[Ul,f(" "+p(s[0].norma-n.totalForEachGroup.totalsForEachGroup[s[0].group_id]),1)])):_("",!0)]),_:2},1032,["onClick"]),a.visibleGroups.includes(h)?(i(),m("div",Hl,[l(H,{hover:"",dense:""},{default:r(()=>[Rl,d("tbody",null,[(i(!0),m(b,null,P(s,(g,M)=>(i(),m("tr",{key:M,onClick:E=>n.editTool(g.id)},[d("td",zl,p(M+1),1),d("td",null,[f(p(g.name)+" ",1),g.group_standard?(i(),m("span",$l,"★")):_("",!0)]),d("td",null,p(g.path),1),d("td",null,p(g.sklad),1),d("td",null,p(M===0?g.norma:""),1)],8,Nl))),128))])]),_:2},1024)])):_("",!0)]))),128))])],64)}const ql=I(xl,[["render",Gl]]);const jl={name:"TreeNode",props:{node:{type:Object,required:!0}},data(){return{isExpanded:!1}},computed:{appColor(){return"cyan-darken-3"}},methods:{toggle(){this.isExpanded=!this.isExpanded}}},Ql={class:"tree-node"},Zl={class:"pr-2"},Wl={key:0},Kl={class:"node-id"},Jl={key:0,class:"pl-3"};function Xl(e,t,o,c,a,n){const u=C("tree-node",!0);return i(),y(N,null,{default:r(()=>[d("div",Ql,[l(k,{variant:"plain",density:"compact",icon:"",disabled:!o.node.nodes||o.node.nodes.length===0,onClick:ie(n.toggle,["stop"])},{default:r(()=>[l(w,{size:"x-small"},{default:r(()=>[f(p(a.isExpanded?"mdi-chevron-down":"mdi-chevron-right"),1)]),_:1})]),_:1},8,["disabled","onClick"]),l(w,{class:"pl-4 pr-4",color:n.appColor,icon:"mdi-folder"},null,8,["color"]),d("span",{class:A({"text-grey":o.node.totalElements===0})},[d("span",Zl,p(o.node.label),1),o.node.available!==0?(i(),m("span",Wl,[l(O,{size:"x-small",class:"ma-2",color:"secondary",label:""},{default:r(()=>[f(p(o.node.available)+" / "+p(o.node.elements),1)]),_:1})])):_("",!0),d("span",Kl,"id: "+p(o.node.id),1)],2),a.isExpanded&&o.node.nodes&&o.node.nodes.length?(i(),m("div",Jl,[(i(!0),m(b,null,P(o.node.nodes,s=>(i(),y(u,{key:s.id,node:s,class:"child-node"},null,8,["node"]))),128))])):_("",!0)])]),_:1})}const Yl=I(jl,[["render",Xl],["__scopeId","data-v-db4022d8"]]),ea={name:"TreeView",components:{TreeNode:Yl},data(){return{treeData:[]}},async created(){await this.refreshTreeData()},methods:{async refreshTreeData(){try{const e=await B.getTree();if(e&&e.length>0){const t=e.find(o=>o.id===1);this.treeData=t&&t.nodes?t.nodes:[]}}catch(e){console.error("Ошибка при обновлении дерева:",e)}}}};function ta(e,t,o,c,a,n){const u=C("tree-node");return i(),y(be,null,{default:r(()=>[l(_e,null,{default:r(()=>[l(V,null,{default:r(()=>[l(S,{justify:"end"},{default:r(()=>[l(v,{cols:"auto"},{default:r(()=>[l(k,{variant:"text",onClick:n.refreshTreeData},{default:r(()=>[l(w,{left:""},{default:r(()=>[f("mdi-refresh")]),_:1}),f(" Обновить ")]),_:1},8,["onClick"])]),_:1})]),_:1}),l(N,{class:"mt-4"},{default:r(()=>[(i(!0),m(b,null,P(a.treeData,s=>(i(),y(u,{key:s.id,node:s,onRefreshNode:n.refreshTreeData},null,8,["node","onRefreshNode"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})}const oa=I(ea,[["render",ta]]);function ae(e){return e.data}const Pe={genBuchWeek:async()=>D.get("/report/buch-week").then(ae).catch(T),getToolMovementById:async e=>D.get(`/tool-movement/${e}`).then(ae).catch(T),genNalad:async e=>D.get("/report/setup",{headers:{Authorization:`Bearer ${e}`}}).then(ae).catch(T),genZayavInstr:async e=>D.get("/report/zayav-instr",{headers:{Authorization:`Bearer ${e}`}}).then(ae).catch(T),genRevisionInstr:async e=>D.get("/report/revision-instr",{headers:{Authorization:`Bearer ${e}`}}).then(ae).catch(T),getZakaz:async()=>D.get("/report/get-zakaz").then(ae).catch(T)},la=Je("reportZakaz",{state:()=>({isModalOpen:!1,selectedToolId:null}),actions:{openModal(e){this.selectedToolId=e,this.isModalOpen=!0},closeModal(){this.isModalOpen=!1}},getters:{getModalStatus(e){return e.isModalOpen},getSelectedToolId(e){return e.selectedToolId}}}),aa=rt({name:"FillingModal",components:{Modal:G},props:{toolId:{type:Number,default:null}},setup(e){const t=la(),o=Se(()=>t.movements),c=Se(()=>{const n=t.getTool;return(n==null?void 0:n.id)!=null?`Движение инструмента на складе: ${n.name} (ID: ${n.id})`:"Движение инструмента"});return nt(async()=>{e.toolId&&await t.fetchMovementHistory(e.toolId)}),{movements:o,popupTitle:c,formatDate:n=>z(Q(n),"dd.MM.yy HH:mm:ss")}}}),sa=d("thead",null,[d("tr",null,[d("th"),d("th",null,"Дата"),d("th",null,"Комментарий"),d("th",null,"Было"),d("th",null,"Стало"),d("th",null,"Изменение"),d("th",null,"Выдал/Внёс")])],-1),ra={class:"gray"},na={style:{color:"grey"}},ia={style:{color:"grey"}},da={key:2};function ca(e,t,o,c,a,n){const u=C("Modal");return i(),y(u,{title:e.popupTitle,"width-default":"1550px"},{content:r(()=>[l(V,null,{default:r(()=>[l(H,{hover:""},{default:r(()=>[sa,d("tbody",null,[(i(!0),m(b,null,P(e.movements,(s,h)=>(i(),m("tr",{key:s.id},[d("td",ra,p(h+1),1),d("td",null,p(e.formatDate(s.datetime_log)),1),d("td",null,p(s.message),1),d("td",na,p(s.old_amount),1),d("td",ia,p(s.new_amount),1),d("td",null,[s.change>0?(i(),y(w,{key:0,small:"",color:"green",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-up ")]),_:1})):_("",!0),s.change<0?(i(),y(w,{key:1,small:"",color:"red",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-down ")]),_:1})):_("",!0),s.change!==0?(i(),m("span",da,p(s.change),1)):_("",!0)]),d("td",null,p(s.user_login||"Неопределен"),1)]))),128))])]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:t[0]||(t[0]=s=>e.$emit("close"))},{default:r(()=>[f(" Закрыть ")]),_:1}),l(x)]),_:1},8,["title"])}const ua=I(aa,[["render",ca]]);function se(e){return e.data}const Ce={addTool:async e=>D.post("/tool",e).then(se).catch(T),deleteTool:async e=>D.delete(`/tool/${e}`).then(se).catch(T),updateTool:async(e,t)=>D.put(`/tool/${e}`,t).then(se).catch(T),getToolParamsByParentId:async e=>D.get(`/tools-params/${e}`).then(se).catch(T),getToolNamesByParentId:async e=>D.get(`/tools-params-name/${e}`).then(se).catch(T),getToolMovementById:async e=>D.get(`/tool-movement/${e}`).then(se).catch(T)},ha={name:"FillingModal",components:{Modal:G},props:{persistent:{type:Boolean,default:!1},toolId:{type:Number,default:null}},emits:["canceled","changes-saved"],data(){return{cartItems:[],snackbar:{show:!1,color:"error",text:""},toolModel:{name:null,property:{},limit:null,sklad:null,norma:null},toolNameOptions:[],parameterValuePairs:[{parameter:null,value:null}],toolParamOptions:[],toolParamsOptions:{},selectedParams:[],toolParams:[],confirmDeleteDialog:!1,typeSelected:!1,selectedType:"",parentIdRules:[e=>!!e||"ID папки обязательно",e=>e>1||"ID папки должен быть больше 1",e=>e!==""||"ID папки не должен быть пустым"],typeRules:[e=>!!e||"Поле обязательно для заполнения",e=>e&&e.length>=3||"Минимальная длина: 3 символа"]}},computed:{...U("EditorToolStore",["nameOptions","tool","parentCatalog"]),availableToolParamOptions(){return this.toolParamOptions.filter(e=>!this.selectedParams.includes(e))},isAddButtonVisible(){const e=new Set(Object.keys(this.toolModel.property)).size,t=this.toolParams.length;return e<t},selectedParamsInfo(){return Object.entries(this.toolModel.property).map(([e,t])=>{const o=this.toolParams.find(c=>c.id.toString()===e);return o?{...o,value:t}:null}).filter(e=>e!==null)},popupTitle(){var e,t;return((e=this.tool)==null?void 0:e.id)!=null?`Движение инструмента на складе: ${(t=this.cartItems[0])==null?void 0:t.name} (ID: ${this.tool.id})`:"Движение инструмента"}},watch:{toolId:{immediate:!0,async handler(e){e==null?this.resetToolModel():(await this.fetchToolById(e),this.updateToolModel())}}},async created(){await this.fetchToolMovement(),await this.fetchToolParamsByParentId(this.parentCatalog.id),await this.fetchToolNamesByParentId(this.parentCatalog.id);try{const e=await xe();if(this.toolParams=[...e],this.toolParamOptions=e.map(t=>t.info),this.toolModel.property&&Object.keys(this.toolModel.property).length>0){const t=Object.keys(this.toolModel.property);this.selectedParams=this.toolParams.filter(o=>t.includes(String(o.id))).map(o=>o.info)}}catch(e){console.error("Ошибка при загрузке параметров инструмента:",e)}this.toolId==null?this.setTool({id:null,name:null,property:{}}):(await this.fetchToolById(this.toolId),this.tool&&this.tool.property===null&&(this.tool.property={}))},methods:{...R("EditorToolStore",["fetchToolsByFilter","fetchToolById"]),...$("EditorToolStore",["setTool"]),formatDate(e){return z(Q(e),"dd.MM.yy HH:mm:ss")},async fetchToolMovement(){if(this.toolId)try{const e=await Ce.getToolMovementById(this.toolId);this.cartItems=e.map(t=>({id:t.log_id,name:t.tool_name,date:this.formatDate(t.datetime_log),was:t.old_amount,now:t.new_amount,change:t.new_amount-(t.old_amount||t.new_amount),comment:t.message,user:t.user_login||"Неопределен"}))}catch(e){console.error("Ошибка при получении данных о движении инструмента:",e),this.showErrorSnackbar("Ошибка загрузки данных.")}},showErrorSnackbar(e){this.snackbar.text=e,this.snackbar.color="error",this.snackbar.show=!0},async fetchToolNamesByParentId(e){try{this.toolNameOptions=await Ce.getToolNamesByParentId(e)}catch(t){console.error("Ошибка при получении названий инструментов:",t)}},async fetchToolParamsByParentId(e){try{const t=await Ce.getToolParamsByParentId(e);let o={};t.forEach(c=>{o[c.id]=c.values}),this.toolParamsOptions=o}catch(t){console.error("Ошибка при получении данных о параметрах:",t)}},removeParameter(e){window.confirm("Вы уверены, что хотите удалить этот параметр?")&&(delete this.toolModel.property[e],this.toolModel.property={...this.toolModel.property},this.updateSelectedParams())},selectParam(e){const t=this.toolParams.find(o=>o.info===e);if(t){const o={...this.toolModel.property};delete o[-1],o[t.id]=this.toolModel.property[-1]||"",this.toolModel.property=o,this.updateSelectedParams()}},updateSelectedParams(){this.selectedParams=Object.keys(this.toolModel.property).map(e=>{const t=this.toolParams.find(o=>String(o.id)===e);return t?t.info:null}).filter(e=>e!==null)},resetToolModel(){this.toolModel={name:null,limit:null,sklad:null,norma:null,property:{}}},addParameterValuePair(){if(!this.selectedParams.includes("-1")){const e={id:-1,info:null};this.toolParams.push(e),this.toolModel.property[e.id]=null,this.updateSelectedParams()}},updateToolModel(){this.tool&&(this.toolModel=JSON.parse(JSON.stringify(this.tool)))},prependOptionIfNeeded(e,t){e&&!t.some(o=>o.value===e)&&t.unshift(e)},prepareFioOptions(e){return e.map(t=>({text:t.fio,value:t.id}))},confirmDelete(){window.confirm("Вы уверены, что хотите удалить этот инструмент?")&&this.onDelete()},async onDelete(){const{id:e}=this.toolModel;if(e!=null)try{(await Ce.deleteTool(e)).success==="OK"&&this.$emit("changes-saved")}catch(t){console.error("Ошибка при удалении инструмента:",t),this.showErrorSnackbar("Инструмент используется в истории.")}},onCancel(){this.$emit("canceled")}}},ma=d("thead",null,[d("tr",null,[d("th"),d("th",null,"Дата"),d("th",null,"Комментарий"),d("th",null,"Было"),d("th",null,"Стало"),d("th",null,"Изменение"),d("th",null,"Выдал/Внёс"),d("th")])],-1),pa={class:"gray"},fa={style:{color:"grey"}},ya={style:{color:"grey"}},ga={key:2};function _a(e,t,o,c,a,n){const u=C("Modal",!0);return i(),m(b,null,[l(u,{title:n.popupTitle,"width-default":"1550px"},{content:r(()=>[l(V,null,{default:r(()=>[l(H,{hover:""},{default:r(()=>[ma,d("tbody",null,[(i(!0),m(b,null,P(a.cartItems,(s,h)=>(i(),m("tr",{key:s.id},[d("td",pa,p(h+1),1),d("td",null,p(s.date),1),d("td",null,p(s.comment),1),d("td",fa,p(s.was),1),d("td",ya,p(s.now),1),d("td",null,[s.change>0?(i(),y(w,{key:0,small:"",color:"green",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-up ")]),_:1})):_("",!0),s.change<0?(i(),y(w,{key:1,small:"",color:"red",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-down ")]),_:1})):_("",!0),s.change!==0?(i(),m("span",ga,p(s.change),1)):_("",!0)]),d("td",null,p(s.user),1)]))),128))])]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"]),l(x)]),_:1},8,["title"]),l(de,{modelValue:a.snackbar.show,"onUpdate:modelValue":t[1]||(t[1]=s=>a.snackbar.show=s),color:a.snackbar.color,bottom:"",right:""},{default:r(()=>[f(p(a.snackbar.text)+" ",1),l(k,{color:"white",text:"",onClick:t[0]||(t[0]=s=>a.snackbar.show=!1)},{default:r(()=>[f("Закрыть")]),_:1})]),_:1},8,["modelValue","color"])],64)}const ut=I(ha,[["render",_a]]);const ba={components:{ZakazToolModal:ut,Modal:ua},data(){return{toolGroups:[],visibleGroups:[],editingToolId:null,openDialog:!1,isAllVisible:!1,hasMovementHistory:!1,colors:{red:"#dc3545",yellow:"#ffc107",green:"#28a745"},toolTableHeaders:[{title:"№",key:"index",width:"50px"},{title:"Название",key:"name"},{title:"Заказ",key:"zakaz",width:"150px"},{title:"Склад",key:"sklad",width:"150px"},{title:"Норма",key:"norma",width:"180px"},{title:"Не хватает",key:"not_enough",width:"150px"},{title:"История",key:"history",width:"15px"}]}},props:{items:{type:Array,required:!0},groupPath:{type:String,required:!0}},mounted(){this.$emit("lowest-color",this.getLowestGroupColor())},methods:{onClosePopup(){this.openDialog=!1},getLowestGroupColor(){let e=1;return this.items.forEach(t=>{const o=this.calcRatio(t);o<e&&(e=o)}),this.getToolColor(e)},getColorForGroup(e){return`hsl(${e*137.508%360}, 50%, 50%)`},getRoundedCount(e){return e<10?10:e%10<5?Math.floor(e/10)*10:Math.ceil(e/10)*10},calcPercent(e){return((1-(e.group_sklad||e.sklad)/(e.norma_green||e.norma))*100).toFixed(0)},getToolColor(e){return e>=.8?this.colors.green:e>=.4?this.colors.yellow:this.colors.red},getNormaForCalculation(e){let t=e.group_sklad||e.sklad;return e.norma_green&&t<e.norma_green?e.norma_green:e.norma_red&&t<e.norma_red?e.norma_red:e.norma},calcRatio(e){let t=e.group_sklad||e.sklad;const o=this.getNormaForCalculation(e);return o===0?0:t/o}}},Ta=["width"],ka=["onClick"],va={style:{"text-align":"center"},class:"grey"},Ia={key:0,style:{color:"yellow"}},Ca={key:0,class:"grey"},wa={class:"grey"},Pa={class:"grey"},Da={key:0},Sa={key:1},Ma={style:{"text-align":"center"}},Fa={style:{"text-align":"center"}};function Va(e,t,o,c,a,n){const u=C("zakaz-tool-modal");return i(),m(b,null,[a.openDialog?(i(),y(u,{key:0,persistent:!0,"tool-id":a.editingToolId,onCanceled:n.onClosePopup},null,8,["tool-id","onCanceled"])):_("",!0),l(H,{hover:"",dense:""},{default:r(()=>[d("thead",null,[d("tr",null,[(i(!0),m(b,null,P(a.toolTableHeaders,s=>(i(),m("th",{key:s.key,class:"text-left",width:s.width},p(s.title),9,Ta))),128))])]),d("tbody",null,[(i(!0),m(b,null,P(o.items,(s,h)=>(i(),m("tr",{key:h,onClick:g=>e.$emit("row-click",s)},[d("td",va,p(h+1),1),d("td",null,[f(p(s.name)+" ",1),s.group_id?(i(),y(O,{key:0,size:"x-small",color:n.getColorForGroup(s.group_id),title:"Группа "+s.group_id},{default:r(()=>[s.group_standard?(i(),m("span",Ia," ★ ")):_("",!0),f(" G"+p(s.group_id),1)]),_:2},1032,["color","title"])):_("",!0)]),d("td",null,[f(p(o.groupPath.includes("Пластины")&&s.zakaz!==0?n.getRoundedCount(s.zakaz):s.zakaz)+" ",1),o.groupPath.includes("Пластины")&&s.zakaz!==0&&s.zakaz!==n.getRoundedCount(s.zakaz)?(i(),m("span",Ca," ("+p(s.zakaz)+")",1)):_("",!0)]),d("td",wa,p(s.group_sklad?`*${s.group_sklad}`:s.sklad),1),d("td",Pa,[s.norma_green?(i(),m("span",Da,p(s.norma_green)+" | ",1)):_("",!0),f(" "+p(s.norma)+" ",1),s.norma_red?(i(),m("span",Sa," | "+p(s.norma_red),1)):_("",!0)]),d("td",Ma,[l(Mt,{rounded:"","model-value":n.calcPercent(s),height:"25",color:n.getToolColor(n.calcRatio(s))},{default:r(()=>[f(p(n.calcPercent(s))+"% ",1)]),_:2},1032,["model-value","color"])]),d("td",Fa,[l(k,{size:"small",icon:"mdi mdi-history",disabled:!s.hasMovementHistory},null,8,["disabled"])])],8,ka))),128))])]),_:1})],64)}const xa=I(ba,[["render",Va]]);const Oa={components:{GroupZakazTable:xa},data(){return{toolGroups:[],visibleGroups:[],editingToolId:null,openDialog:!1,isAllVisible:!1}},mounted(){this.fetchZakazData()},computed:{totalToolCount(){return this.toolGroups.reduce((e,t)=>e+t.tools.length,0)}},methods:{updateGroupLowestColor(e,t){this.toolGroups[e].lowestColor=t,this.toolGroups[e].hasLowStock=t!=="#28a745"},checkGroupForLowStock(e){return e.some(t=>(1-this.calcRatio(t))*100>=20)},calcRatio(e){let t=e.sklad;e.group_id&&e.group_sklad&&(t=e.group_sklad);const o=this.getNormaForCalculation(e);return o===0?0:t/o},getNormaForCalculation(e){return e.norma_green&&e.sklad<e.norma_green?e.norma_green:e.norma_red&&e.sklad<e.norma_red?e.norma_red:e.norma},async fetchZakazData(){try{const e=await Pe.getZakaz();this.toolGroups=e.map(t=>({...t,lowestColor:this.getLowestGroupColor(t.tools),hasLowStock:this.checkGroupForLowStock(t.tools)}))}catch(e){console.error("Ошибка при получении данных: ",e)}},getLowestGroupColor(e){let t=1;return e.forEach(o=>{const c=this.calcRatio(o);c<t&&(t=c)}),this.getToolColor(t)},getToolColor(e){return e>=.8?"#28a745":e>=.4?"#ffc107":"#dc3545"},toggleVisibility(e){const t=this.visibleGroups.indexOf(e);t===-1?this.visibleGroups.push(e):this.visibleGroups.splice(t,1)},toggleAllVisibility(){this.isAllVisible=!this.isAllVisible,this.visibleGroups=this.isAllVisible?[...Array(this.toolGroups.length).keys()]:[]},sortedTools(e){return[...e].sort((t,o)=>this.calcPercent(o)-this.calcPercent(t))},calcPercent(e){const t=e.group_sklad||e.sklad,o=this.getNormaForCalculation(e);return((1-t/o)*100).toFixed(0)}}},Aa={class:"d-flex justify-end"},Ea={key:0};function Ba(e,t,o,c,a,n){const u=C("group-zakaz-table");return i(),m("div",null,[d("div",Aa,[l(k,{variant:"text",onClick:n.toggleAllVisibility},{default:r(()=>[f(p(a.isAllVisible?"Свернуть все":"Развернуть все")+" ("+p(n.totalToolCount)+") ",1)]),_:1},8,["onClick"])]),(i(!0),m(b,null,P(a.toolGroups,(s,h)=>(i(),m("div",{key:h,class:"tool-group"},[l(O,{variant:"text",size:"large",onClick:g=>n.toggleVisibility(h)},{prepend:r(()=>[s.hasLowStock?(i(),y(w,{key:1,icon:"mdi-folder-alert",start:"",color:s.lowestColor,title:"Есть позиции с низким запасом"},null,8,["color"])):(i(),y(w,{key:0,color:"green",icon:"mdi-folder",start:""}))]),default:r(()=>[f(" "+p(s.path),1)]),_:2},1032,["onClick"]),l(O,{color:"while"},{default:r(()=>[f(p(s.tools.length),1)]),_:2},1024),a.visibleGroups.includes(h)?(i(),m("div",Ea,[l(u,{items:n.sortedTools(s.tools),"group-path":s.path,onLowestColor:g=>n.updateGroupLowestColor(h,g)},null,8,["items","group-path","onLowestColor"])])):_("",!0)]))),128))])}const La=I(Oa,[["render",Ba]]),Ua={components:{ReportZakaz:La},data(){return{reports:[{name:"⭐ Заявка на инструмент",info:"каждый четверг",action:this.genZayavInstrWeek},{name:"Ревизия",info:"весь инструмент",action:this.genRevisionInstrWeek},{name:"По наладкам",info:"Дополнительно",action:this.genNalad}],hasAccess:!1}},mounted(){this.checkLogin()},methods:{async sendEmailReport(e){e.loading=!0;try{await e.action()}catch(t){console.error("Ошибка при отправке отчета:",t)}finally{e.loading=!1}},async genNalad(){const e=localStorage.getItem("token");if(!e){console.error("No token found in local storage.");return}try{await Pe.genNalad(e)}catch(t){console.error("Error while generating report:",t)}},async genZayavInstrWeek(){const e=localStorage.getItem("token");if(!e){console.error("No token found in local storage.");return}try{await Pe.genZayavInstr(e)}catch(t){console.error("Error while generating report:",t)}},async genRevisionInstrWeek(){const e=localStorage.getItem("token");if(!e){console.error("No token found in local storage.");return}try{await Pe.genRevisionInstr(e)}catch(t){console.error("Error while generating report:",t)}},async checkLogin(){const e=localStorage.getItem("token");if(!e){this.hasAccess=!1;return}try{const t=await ye.checkLogin(e);t.status==="ok"?(this.userRole=t.role,this.hasAccess=this.userRole==="Editor"||this.userRole==="Admin"):this.hasAccess=!1}catch(t){console.error("Ошибка при проверке логина:",t),this.hasAccess=!1}}}},Ha=d("thead",null,[d("tr",null,[d("th",{class:"text-left"},"Название"),d("th",{class:"text-left"},"Информация"),d("th",{class:"text-left"},"На почту")])],-1);function Ra(e,t,o,c,a,n){const u=C("ReportZakaz");return i(),m(b,null,[l(V,null,{default:r(()=>[a.hasAccess?(i(),y(S,{key:0},{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(H,null,{default:r(()=>[Ha,d("tbody",null,[(i(!0),m(b,null,P(a.reports,(s,h)=>(i(),m("tr",{key:h},[d("td",null,p(s.name),1),d("td",null,p(s.info),1),d("td",null,[l(k,{color:"primary",loading:s.loading,disabled:s.loading,onClick:g=>n.sendEmailReport(s)},{default:r(()=>[f(" Email ")]),_:2},1032,["loading","disabled","onClick"])])]))),128))])]),_:1})]),_:1})]),_:1})):_("",!0)]),_:1}),l(u)],64)}const Na=I(Ua,[["render",Ra]]);function re(e){return e.data}const ne={getToolMovementById:async e=>D.get(`/tool-movement/${e}`).then(re).catch(T),addTool:async e=>D.post("/tool",e).then(re).catch(T),deleteTool:async e=>D.delete(`/tool/${e}`).then(re).catch(T),updateTool:async(e,t)=>D.put(`/tool/${e}`,t).then(re).catch(T),getToolParamsByParentId:async e=>D.get(`/tools/modal-form/${e}/params`).then(re).catch(T),getToolNamesByParentId:async e=>D.get(`/tools/modal-form/${e}/names`).then(re).catch(T)},Z=Je("editorToolStore",{state:()=>({isLoading:!1,parentCatalog:{id:1,label:null},dynamicFilters:[],nameOptions:[],tool:null,tools:[],toolsTotalCount:0,filters:{currentPage:1,itemsPerPage:15,search:"",includeNull:!1,onlyInStock:null,selectedDynamicFilters:{}},movements:[],tree:[],currentItem:null}),actions:{async fetchTree(){try{this.tree=await B.getTree(),this.currentItem=this.tree[0]}catch(e){console.error("Ошибка при получении дерева инструментов:",e)}},async refreshTree(){await this.fetchTree()},addFolderToTree(e,t){const o={id:e,label:t,elements:0,available:0,nodes:[],totalAvailable:0,totalElements:0};this.currentItem.nodes.push(o),this.currentItem=o,this.tree.push(o)},renameFolderInTree(e,t){const o=this.findFolderById(e);o&&(o.label=t)},goBackInTree(){this.tree.length>1&&(this.tree.pop(),this.currentItem=this.tree[this.tree.length-1],this.parentCatalog.id=this.currentItem.id,this.fetchToolsData())},findFolderById(e,t=this.tree){for(const o of t){if(o.id===e)return o;if(o.nodes){const c=this.findFolderById(e,o.nodes);if(c)return c}}return null},async fetchToolById(e){try{this.tool=await j.getToolById(e),await this.fetchMovementHistory(e)}catch(t){console.error("Ошибка при загрузке инструмента:",t)}},async fetchToolsDynamicFilters(){const{id:e=null}=this.parentCatalog;if(e!==null)try{const t=await j.filterParamsByParentId(e);this.filters.selectedDynamicFilters=t.reduce((o,{key:c})=>({...o,[c]:null}),{}),this.dynamicFilters=t}catch(t){console.error("Ошибка при загрузке динамических фильтров:",t)}},async fetchToolsByFilter(){this.isLoading=!0,this.tools=[];try{const{currentPage:e,itemsPerPage:t,search:o,includeNull:c,onlyInStock:a,selectedDynamicFilters:n}=this.filters,{id:u}=this.parentCatalog,{tools:s,totalCount:h}=await j.getTools(o,e,t,c,u,a,Object.entries(n).reduce((g,[M,E])=>({...g,[`param_${M}`]:E}),{}));this.tools=s,this.toolsTotalCount=h}catch(e){console.error("getTools. Ошибка при получении данных:",e)}finally{this.isLoading=!1}},setSearch(e){this.filters.search=e},setParentCatalog(e){this.parentCatalog={...e},this.currentItem.id=e.id},setDynamicFilters(e){this.dynamicFilters=e},setSelectedDynamicFilters(e){this.filters.selectedDynamicFilters=e},setIsLoading(e){this.isLoading=e},setCurrentPage(e){this.filters.currentPage=e},setFilters(e){this.filters={...e}},setTool(e){this.tool=e},setItemsPerPage(e){this.filters.itemsPerPage=e},setToolsTotalCount(e){this.toolsTotalCount=e},setTools(e){this.tools=e},goToInTree(e){this.currentItem=this.tree[e],this.tree=this.tree.slice(0,e+1),this.parentCatalog.id=this.currentItem.id,this.fetchToolsData()},selectItemInTree(e){this.currentItem=e,this.parentCatalog.id=e.id,this.currentItem.id=e.id,this.tree.includes(e)||this.tree.push(e),this.fetchToolsData()},async fetchMovementHistory(e){try{this.movements=(await ne.getToolMovementById(e)).map(t=>({...t,change:(t.new_amount||0)-(t.old_amount||0)}))}catch(t){console.error("Ошибка при загрузке истории движения:",t)}},async fetchToolsData(){try{await this.fetchToolsDynamicFilters(),await this.fetchToolsByFilter()}catch(e){console.error("Ошибка при получении данных инструментов:",e)}}},getters:{getMovementHistoryByToolId:e=>t=>e.movements.filter(o=>o.tool_id===t),getParentCatalog:e=>e.parentCatalog,getDynamicFilters:e=>e.dynamicFilters,getFilters:e=>({...e.filters}),getTool:e=>e.tool?{...e.tool,property:e.tool.property,parent_id:e.tool.parent_id,folder_name:e.tool.folder_name}:null,getTools:e=>[...e.tools],getFormattedTools:e=>e.tools.map(t=>({...t,...Object.entries(t.property).reduce((o,[c,{value:a}])=>({...o,[c]:a}),{})})),getIsLoading:e=>e.isLoading,getNameOptions:e=>e.nameOptions,getToolsTotalCount:e=>e.toolsTotalCount,getCurrentItem:e=>e.currentItem,getTree:e=>e.tree}}),za={name:"Folder",data(){return{editorToolStore:Z(),isEditing:!1,editableLabel:""}},computed:{currentItem(){return this.editorToolStore.getCurrentItem},tree(){return this.editorToolStore.getTree}},methods:{async deleteItem(){if(!this.currentItem)return alert("Не выбрана папка для удаления.");if(confirm(`Уверены, что хотите удалить ${this.currentItem.label}?`))try{await B.deleteFolder(this.currentItem.id),alert("Папка успешно удалена."),await this.editorToolStore.refreshTree()}catch(e){console.error("Ошибка при удалении:",e),alert("Произошла ошибка при удалении.")}},async addItem(){if(!this.currentItem||!this.currentItem.nodes)return alert("Выберите категорию для добавления новой папки.");let e=prompt("Введите название новой ветки:");if(e)try{const t=await B.addFolder(e,this.currentItem.id);await this.editorToolStore.addFolderToTree(t.newBranchId,e)}catch(t){console.error(t),alert("Произошла ошибка при добавлении ветки.")}},startEditing(){this.isEditing=!0,this.editableLabel=this.currentItem?this.currentItem.label:""},async finishEditing(){if(this.isEditing&&this.currentItem&&this.editableLabel!==this.currentItem.label)try{await B.renameFolder(this.currentItem.id,this.editableLabel),await this.editorToolStore.renameFolderInTree(this.currentItem.id,this.editableLabel)}catch(e){console.error("Ошибка при переименовании:",e),alert("Произошла ошибка при переименовании.")}this.isEditing=!1},goBack(){this.editorToolStore.goBackInTree()}}},$a={class:"text-h6"};function Ga(e,t,o,c,a,n){return i(),y(Ve,{app:"",dark:""},{default:r(()=>[l(We,null,{default:r(()=>{var u;return[d("div",$a,[a.isEditing?(i(),y(F,{key:0,modelValue:a.editableLabel,"onUpdate:modelValue":t[0]||(t[0]=s=>a.editableLabel=s),dense:"",solo:"","hide-details":"",flat:!0,autofocus:!0,onBlur:n.finishEditing,onKeyup:Ft(n.finishEditing,["enter"])},null,8,["modelValue","onBlur","onKeyup"])):(i(),m("span",{key:1,onClick:t[1]||(t[1]=(...s)=>n.startEditing&&n.startEditing(...s))},[f(p(((u=n.currentItem)==null?void 0:u.label)||"[НЕТ НАЗВАНИЯ]")+" ",1),l(k,{title:"Переименовать папку",icon:"",small:"",onClick:ie(n.startEditing,["stop"])},{default:r(()=>[l(w,{icon:"mdi-pencil"})]),_:1},8,["onClick"]),l(k,{title:"Добавить папку",icon:"",small:"",onClick:ie(n.addItem,["stop"])},{default:r(()=>[l(w,{icon:"mdi-folder-plus"})]),_:1},8,["onClick"]),l(k,{title:"Удалить папку",icon:"",small:"",onClick:ie(n.deleteItem,["stop"])},{default:r(()=>[l(w,{icon:"mdi-delete"})]),_:1},8,["onClick"])]))])]}),_:1}),l(x),l(k,{title:"Назад",icon:"",onClick:n.goBack},{default:r(()=>[l(w,{icon:"mdi-arrow-left"})]),_:1},8,["onClick"])]),_:1})}const qa=I(za,[["render",Ga]]);const ja={name:"CatalogBreadcrumbs",emits:["go-to","item-selected"],data(){return{editorToolStore:Z()}},computed:{appColor(){return"cyan-darken-3"},getCurrentItem(){return this.editorToolStore.getCurrentItem},getTree(){return this.editorToolStore.getTree}},methods:{getBreadcrumbClass(e){return{"breadcrumbs-item":e<this.getTree.length-1,"breadcrumbs-item-final":e===this.getTree.length-1}},goTo(e){this.editorToolStore.goToInTree(e)},selectItem(e){this.editorToolStore.selectItemInTree(e)}}},Qa=["onClick"],Za={key:0},Wa={key:0};function Ka(e,t,o,c,a,n){return i(),m("div",null,[(i(!0),m(b,null,P(n.getTree,(u,s)=>(i(),m("span",{key:s},[d("span",{class:A(n.getBreadcrumbClass(s)),onClick:h=>n.goTo(s)},[f(p(u.label)+" ",1),u.available!==0?(i(),m("span",Za," ("+p(u.available)+") ",1)):_("",!0)],10,Qa),s<n.getTree.length-1?(i(),m("span",Wa,"   /   ")):_("",!0)]))),128))])}const Ja=I(ja,[["render",Ka],["__scopeId","data-v-44b2e7cb"]]),Xa=Je("appColor",{state:()=>({color:"cyan-darken-3"})});const Ya={name:"CatalogItem",props:{item:{type:Object,required:!0}},setup(){return{appColor:Xa().color}},methods:{selectItem(){Z().selectItemInTree(this.item)}}},es={class:"flex"},ts={key:0,style:{color:"grey"}};function os(e,t,o,c,a,n){return i(),m("div",null,[l(N,{class:"align-center",onClick:n.selectItem},{default:r(()=>[d("div",es,[l(w,{color:c.appColor,icon:"mdi-folder",class:"icon"},null,8,["color"]),l(Ze,{class:A({"text-grey":o.item.totalElements===0})},{default:r(()=>[f(p(o.item.label)+" ",1),o.item.elements!==0?(i(),m("span",ts,[l(O,{variant:"text"},{default:r(()=>[f(p(o.item.available)+" / "+p(o.item.elements),1)]),_:1})])):_("",!0)]),_:1},8,["class"])])]),_:1},8,["onClick"])])}const ls=I(Ya,[["render",os],["__scopeId","data-v-b23a28ec"]]),as={name:"Catalog",components:{Folder:qa,Breadcrumbs:Ja,CatalogItem:ls},data(){return{editorToolStore:Z()}},async created(){try{await this.editorToolStore.fetchTree()}catch(e){console.error("Ошибка при получении дерева инструментов:",e)}},computed:{currentItems(){var e;return((e=this.editorToolStore.currentItem)==null?void 0:e.nodes)||[]}}};function ss(e,t,o,c,a,n){const u=C("folder"),s=C("Breadcrumbs"),h=C("CatalogItem");return i(),y(be,{class:"custom-container"},{default:r(()=>[l(u),l(_e,null,{default:r(()=>[l(V,{fluid:!0},{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(s),(i(!0),m(b,null,P(n.currentItems,g=>(i(),m("div",{key:g.id},[l(h,{item:g},null,8,["item"])]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}const rs=I(as,[["render",ss]]);var tn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function on(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}const ns={emits:["filter-update"],props:{filters:{type:Array,required:!0}},data(){return{selectedValues:{}}},methods:{updateFilterValue({key:e,value:t}){this.selectedValues={...this.selectedValues,[e]:t},this.$emit("filter-update",this.selectedValues)}}};function is(e,t,o,c,a,n){return i(!0),m(b,null,P(o.filters,(u,s)=>(i(),y(S,{key:`group-${s}`,cols:"12",sm:"6"},{default:r(()=>[(i(!0),m(b,null,P(u,h=>(i(),y(v,{key:h.key,cols:"12",sm:"3"},{default:r(()=>[l(L,{density:"compact",variant:"solo",clearable:"",label:h.label,items:h.values,value:a.selectedValues[h.key],"onUpdate:modelValue":g=>n.updateFilterValue({key:h.key,value:g})},null,8,["label","items","value","onUpdate:modelValue"])]),_:2},1024))),128))]),_:2},1024))),128)}const ds=I(ns,[["render",is]]),cs={components:{DynamicFilters:ds},data(){return{searchQuery:"",editorToolStore:Z()}},computed:{groupedFilters(){const t=[],o=this.editorToolStore.getDynamicFilters;for(let c=0;c<o.length;c+=4)t.push(o.slice(c,c+4));return t},hasDynamicFilters(){return this.editorToolStore.getDynamicFilters.length>0},getIsLoading(){return this.editorToolStore.getIsLoading},getFilters(){return this.editorToolStore.getFilters}},methods:{debounceSearch:Vt.debounce(function(){this.editorToolStore.setSearch(this.searchQuery),this.fetchToolsByFilter()},500),onParamsFilterUpdate(e){this.editorToolStore.setSelectedDynamicFilters({...this.getFilters.selectedDynamicFilters,...e}),this.fetchToolsByFilter()},fetchToolsByFilter(){this.editorToolStore.fetchToolsByFilter()},async fetchToolsDynamicFilters(){await this.editorToolStore.fetchToolsDynamicFilters()}},async mounted(){await this.fetchToolsDynamicFilters()}},us={class:"pt-4"};function hs(e,t,o,c,a,n){const u=C("DynamicFilters");return i(),m("div",us,[n.hasDynamicFilters?(i(),y(S,{key:0},{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(F,{modelValue:a.searchQuery,"onUpdate:modelValue":t[0]||(t[0]=s=>a.searchQuery=s),variant:"outlined",clearable:"","prepend-inner-icon":"mdi-magnify",label:"Поиск по инструменту","hide-details":"",onInput:n.debounceSearch},null,8,["modelValue","onInput"])]),_:1})]),_:1})):_("",!0),n.hasDynamicFilters?(i(),y(u,{key:1,filters:n.groupedFilters,onFilterUpdate:n.onParamsFilterUpdate},null,8,["filters","onFilterUpdate"])):_("",!0)])}const ht=I(cs,[["render",hs]]),ms=rt({name:"FillingModal",components:{Modal:G},props:{toolId:{type:Number,default:null}},setup(e){const t=Z(),o=Se(()=>t.movements),c=Se(()=>{const n=t.getTool;return(n==null?void 0:n.id)!=null?`Движение инструмента на складе: ${n.name} (ID: ${n.id})`:"Движение инструмента"});return nt(async()=>{e.toolId&&await t.fetchMovementHistory(e.toolId)}),{movements:o,popupTitle:c,formatDate:n=>z(Q(n),"dd.MM.yy HH:mm:ss")}}}),ps=d("thead",null,[d("tr",null,[d("th"),d("th",null,"Дата"),d("th",null,"Комментарий"),d("th",null,"Было"),d("th",null,"Стало"),d("th",null,"Изменение"),d("th",null,"Выдал/Внёс")])],-1),fs={class:"gray"},ys={style:{color:"grey"}},gs={style:{color:"grey"}},_s={key:2};function bs(e,t,o,c,a,n){const u=C("Modal");return i(),y(u,{title:e.popupTitle,"width-default":"1550px"},{content:r(()=>[l(V,null,{default:r(()=>[l(H,{hover:""},{default:r(()=>[ps,d("tbody",null,[(i(!0),m(b,null,P(e.movements,(s,h)=>(i(),m("tr",{key:s.id},[d("td",fs,p(h+1),1),d("td",null,p(e.formatDate(s.datetime_log)),1),d("td",null,p(s.message),1),d("td",ys,p(s.old_amount),1),d("td",gs,p(s.new_amount),1),d("td",null,[s.change>0?(i(),y(w,{key:0,small:"",color:"green",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-up ")]),_:1})):_("",!0),s.change<0?(i(),y(w,{key:1,small:"",color:"red",class:"pr-3"},{default:r(()=>[f(" mdi-arrow-down ")]),_:1})):_("",!0),s.change!==0?(i(),m("span",_s,p(s.change),1)):_("",!0)]),d("td",null,p(s.user_login||"Неопределен"),1)]))),128))])]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:t[0]||(t[0]=s=>e.$emit("close"))},{default:r(()=>[f(" Закрыть ")]),_:1}),l(x)]),_:1},8,["title"])}const Ts=I(ms,[["render",bs]]);const ks={name:"FillingModal",components:{Modal:G,ToolMovementModal:Ts},props:{persistent:{type:Boolean,default:!1},toolId:{type:Number,default:null}},emits:["canceled","changes-saved"],data(){return{hasMovementHistory:!1,showMovementModal:!1,tempParentId:null,snackbar:{show:!1,color:"error",text:""},toolModel:{name:null,property:{},group_id:null,group_standard:null,sklad:null,norma:null,norma_green:null,norma_red:null},toolNameOptions:[],toolParamValues:{},selectedParams:[],toolParams:[],parentIdRules:[e=>!!e||"ID папки обязательно",e=>e>1||"ID папки должен быть больше 1",e=>e!==""||"ID папки не должен быть пустым"],typeRules:[e=>!!e||"Поле обязательно для заполнения",e=>e&&e.length>=3||"Минимальная длина: 3 символа"],editorToolStore:Z()}},computed:{currentItem(){return this.editorToolStore.getCurrentItem},availableToolParamOptions(){return this.allToolParamLabels.filter(e=>!this.selectedParams.includes(e))},isAddButtonVisible(){const e=new Set(Object.keys(this.toolModel.property)).size,t=this.toolParams.length;return e<t},selectedParamsInfo(){return Object.entries(this.toolModel.property).map(([e,t])=>{const o=this.toolParams.find(c=>c.id.toString()===e);return o?{...o,value:t}:null}).filter(e=>e!==null)},popupTitle(){return this.toolModel.id!=null?`Редактировать инструмент ID: ${this.toolModel.id}`:"Добавить новый инструмент"},parentCatalog(){return this.editorToolStore.parentCatalog}},watch:{toolId:{immediate:!0,async handler(e){e?await this.loadExistingTool(e):this.resetToolModel(),this.tempParentId=this.currentItem.id,this.hasMovementHistory=this.toolModel.hasMovementHistory}}},async created(){await this.fetchToolData(),await this.initializeToolModel()},methods:{async fetchToolData(){if(this.currentItem){await this.fetchToolParamsByParentId(this.currentItem.id),await this.fetchToolNamesByParentId(this.currentItem.id);try{const e=await xe();this.toolParams=[...e],this.allToolParamLabels=e.map(t=>t.label)}catch(e){console.error("Ошибка при загрузке параметров инструмента:",e)}}},async initializeToolModel(){this.toolId?await this.loadExistingTool(this.toolId):this.resetToolModel()},async loadExistingTool(e){try{await this.editorToolStore.fetchToolById(e),this.toolModel=JSON.parse(JSON.stringify(this.editorToolStore.getTool)),this.toolModel.property===null&&(this.toolModel.property={}),this.updateSelectedParams()}catch{this.showErrorSnackbar("Инструмент не найден.")}},showErrorSnackbar(e){this.snackbar.text=e,this.snackbar.color="error",this.snackbar.show=!0},async fetchToolNamesByParentId(e){try{this.toolNameOptions=await ne.getToolNamesByParentId(e)}catch(t){console.error("Ошибка при получении названий инструментов:",t)}},async fetchToolParamsByParentId(e){try{const t=await ne.getToolParamsByParentId(e);this.toolParamValues=t.reduce((o,c)=>(o[c.id]=c.values,o),{})}catch(t){console.error("Ошибка при получении данных о параметрах:",t)}},removeParameter(e){window.confirm("Вы уверены, что хотите удалить этот параметр?")&&(delete this.toolModel.property[e],this.toolModel.property={...this.toolModel.property},this.updateSelectedParams())},selectParam(e){const t=this.toolParams.find(o=>o.label===e);if(t){const o={...this.toolModel.property};delete o[-1],o[t.id]=this.toolModel.property[-1]||"",this.toolModel.property=o,this.updateSelectedParams()}},updateSelectedParams(){this.selectedParams=Object.keys(this.toolModel.property).map(e=>{const t=this.toolParams.find(o=>String(o.id)===e);return t?t.label:null}).filter(e=>e!==null)},resetToolModel(){this.toolModel={name:null,limit:null,sklad:null,norma:null,property:{},group_id:0,group_standard:null}},addParameterValuePair(){if(!this.selectedParams.includes("-1")){const e={id:-1,label:null};this.toolParams.push(e),this.toolModel.property[e.id]=null,this.updateSelectedParams()}},confirmDelete(){window.confirm("Вы уверены, что хотите удалить этот инструмент?")&&this.onDelete()},async onDelete(){try{(await ne.deleteTool(this.toolModel.id)).success==="OK"&&this.$emit("changes-saved")}catch(e){console.error("Ошибка при удалении инструмента:",e),this.showErrorSnackbar("Инструмент используется в истории.")}},onCancel(){this.$emit("canceled")},async onSave(){const e=localStorage.getItem("token"),t={...this.toolModel,parent_id:this.tempParentId,editToken:e};try{let o;this.toolId?o=await ne.updateTool(this.toolId,t):o=await ne.addTool(t),o.success==="OK"&&this.$emit("changes-saved")}catch(o){console.error("Ошибка при сохранении:",o.response?o.response.data:o)}}}},vs=e=>(Me("data-v-d0b49e40"),e=e(),Fe(),e),Is={class:"d-flex"},Cs={class:"pl-10"},ws=vs(()=>d("h2",{class:"text-h6"},"Характеристики:",-1));function Ps(e,t,o,c,a,n){const u=C("ToolMovementModal"),s=C("Modal",!0);return i(),m(b,null,[l(s,{title:n.popupTitle,"width-default":"650px"},{content:r(()=>[l(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"6"},{default:r(()=>[l(F,{modelValue:n.currentItem.label,"onUpdate:modelValue":t[0]||(t[0]=h=>n.currentItem.label=h),label:"Папка",variant:"solo",density:"compact",required:"",type:"Text",disabled:!0},null,8,["modelValue"])]),_:1}),l(v,{cols:"6"},{default:r(()=>[l(F,{variant:"solo",density:"compact",modelValue:a.tempParentId,"onUpdate:modelValue":t[1]||(t[1]=h=>a.tempParentId=h),label:"ID папки",required:"",type:"Number",rules:a.parentIdRules},null,8,["modelValue","rules"])]),_:1})]),_:1}),l(S,null,{default:r(()=>[l(v,{cols:"6",class:"pl-10"},{default:r(()=>[l(Te,{modelValue:a.toolModel.group_standard,"onUpdate:modelValue":t[2]||(t[2]=h=>a.toolModel.group_standard=h),label:"Эталон группы",color:"yellow"},null,8,["modelValue"])]),_:1}),l(v,{cols:"6"},{default:r(()=>[l(F,{modelValue:a.toolModel.group_id,"onUpdate:modelValue":t[3]||(t[3]=h=>a.toolModel.group_id=h),label:"ID группы",variant:"solo",density:"compact",required:"",type:"Number"},null,8,["modelValue"])]),_:1})]),_:1}),l(v,{cols:"11",class:"pa-1"},{default:r(()=>[d("div",Is,[l(L,{modelValue:a.toolModel.name,"onUpdate:modelValue":t[4]||(t[4]=h=>a.toolModel.name=h),variant:"outlined",label:"Маркировка",items:a.toolNameOptions,"item-text":"text","item-value":"value",required:"",rules:a.typeRules},null,8,["modelValue","items","rules"]),d("div",Cs,[l(k,{icon:"mdi mdi-information-slab-circle-outline",onClick:t[5]||(t[5]=h=>a.showMovementModal=!0),disabled:!a.hasMovementHistory},null,8,["disabled"])]),a.showMovementModal?(i(),y(u,{key:0,"tool-id":o.toolId,onClose:t[6]||(t[6]=h=>a.showMovementModal=!1)},null,8,["tool-id"])):_("",!0)])]),_:1}),ws,(i(!0),m(b,null,P(n.selectedParamsInfo,(h,g)=>(i(),m("div",{key:h.id},[l(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"6",class:"pa-1"},{default:r(()=>[l(W,{modelValue:h.label,"onUpdate:modelValue":[M=>h.label=M,M=>n.selectParam(M,g)],variant:"solo-filled",density:"compact",items:n.availableToolParamOptions,label:"Параметр","single-line":"",solo:""},null,8,["modelValue","onUpdate:modelValue","items"])]),_:2},1024),l(v,{cols:"5",class:"pa-1"},{default:r(()=>[l(L,{modelValue:a.toolModel.property[h.id],"onUpdate:modelValue":M=>a.toolModel.property[h.id]=M,density:"compact",items:a.toolParamValues[h.id],label:"Значение",variant:"outlined",clearable:"","single-line":"",solo:""},null,8,["modelValue","onUpdate:modelValue","items"])]),_:2},1024),l(v,{cols:"1"},{default:r(()=>[l(k,{class:"delete-icon",size:"x-small",icon:"",onClick:M=>n.removeParameter(h.id)},{default:r(()=>[d("span",null,[l(w,null,{default:r(()=>[f("mdi-delete")]),_:1})])]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),l(S,{justify:"center"},{default:r(()=>[l(v,{cols:"12",class:"text-center mb-4"},{default:r(()=>[at(l(k,{color:"primary",onClick:n.addParameterValuePair},{default:r(()=>[f(" Добавить ")]),_:1},8,["onClick"]),[[st,n.isAddButtonVisible]])]),_:1})]),_:1}),l(De,{class:"my-1"}),l(S,null,{default:r(()=>[l(v,{cols:"3"},{default:r(()=>[l(F,{disabled:a.toolModel.group_id&&!a.toolModel.group_standard,modelValue:a.toolModel.norma_green,"onUpdate:modelValue":t[7]||(t[7]=h=>a.toolModel.norma_green=h),type:"number",color:"green",label:"Норма макс",required:""},{"append-inner":r(()=>[l(w,{color:"green"},{default:r(()=>[f("mdi-alert-box")]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1}),l(v,{cols:"3"},{default:r(()=>[l(F,{disabled:a.toolModel.group_id&&!a.toolModel.group_standard,modelValue:a.toolModel.norma,"onUpdate:modelValue":t[8]||(t[8]=h=>a.toolModel.norma=h),type:"number",color:"yellow",label:"Норма",required:""},{"append-inner":r(()=>[l(w,{color:"yellow"},{default:r(()=>[f("mdi-alert-box")]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1}),l(v,{cols:"3"},{default:r(()=>[l(F,{disabled:a.toolModel.group_id&&!a.toolModel.group_standard,modelValue:a.toolModel.norma_red,"onUpdate:modelValue":t[9]||(t[9]=h=>a.toolModel.norma_red=h),type:"number",color:"red","color-icon":"red",label:"Норма мин",required:""},{"append-inner":r(()=>[l(w,{color:"red"},{default:r(()=>[f("mdi-alert-box")]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1}),l(v,{cols:"3"},{default:r(()=>[l(F,{"append-inner-icon":"mdi-package",modelValue:a.toolModel.sklad,"onUpdate:modelValue":t[10]||(t[10]=h=>a.toolModel.sklad=h),type:"number",label:"Склад",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.confirmDelete},{default:r(()=>[f(" Удалить ")]),_:1},8,["onClick"]),l(x),l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"]),l(k,{"prepend-icon":"mdi-check",class:"text-none text-subtitle-1 pl-3",color:"green",size:"large",variant:"flat",onClick:n.onSave},{default:r(()=>[f(" Сохранить ")]),_:1},8,["onClick"])]),_:1},8,["title"]),l(de,{modelValue:a.snackbar.show,"onUpdate:modelValue":t[12]||(t[12]=h=>a.snackbar.show=h),color:a.snackbar.color,bottom:"",right:""},{default:r(()=>[f(p(a.snackbar.text)+" ",1),l(k,{color:"white",text:"",onClick:t[11]||(t[11]=h=>a.snackbar.show=!1)},{default:r(()=>[f("Закрыть")]),_:1})]),_:1},8,["modelValue","color"])],64)}const Ds=I(ks,[["render",Ps],["__scopeId","data-v-d0b49e40"]]);const Ss={components:{EditorToolModal:Ds,ToolFilter:ht},props:{namespace:{type:String,default:"tool"}},data(){return{editorToolStore:Z(),openDialog:!1,isDataLoaded:!1,editingToolId:null,toolTableHeaders:[]}},computed:{formattedTools(){return this.editorToolStore.getFormattedTools},totalToolsCount(){return this.editorToolStore.getToolsTotalCount},itemsPerPage(){return this.editorToolStore.getFilters.itemsPerPage},currentPage(){return this.editorToolStore.getFilters.currentPage},isLoading(){return this.editorToolStore.getIsLoading},currentItem(){return this.editorToolStore.getCurrentItem},dynamicFilters(){return this.editorToolStore.getDynamicFilters}},watch:{"editorToolStore.parentCatalog.id":{handler(e){e!=null&&this.fetchToolsData()}},dynamicFilters:{immediate:!0,handler(e){this.toolTableHeaders=[{title:"№",key:"index",sortable:!1},{title:"Маркировка",key:"name",sortable:!1},{title:"Склад",key:"sklad",sortable:!1},{title:"Норма",key:"norma",sortable:!1},...e&&e.length>0?e.map(({label:t,key:o})=>({title:t,key:o,sortable:!1})):[]]}}},mounted(){this.fetchToolsData(),this.isDataLoaded=!0},methods:{getToolGroupColor(e){return`hsl(${e*137.508%360}, 50%, 50%)`},handlePageChange(e){this.editorToolStore.setCurrentPage(e),this.fetchToolsByFilter()},handleItemsPerPageChange(e){this.editorToolStore.setItemsPerPage(e),this.fetchToolsByFilter()},calculateItemIndex(e){return e+1+(this.editorToolStore.getFilters.currentPage-1)*this.editorToolStore.getFilters.itemsPerPage},calculateToolOrder(e){const t=e.norma-e.sklad;return t<0?"":t},onClosePopup(){this.openDialog=!1},handleSaveChanges(){this.openDialog=!1,this.fetchToolsData()},onAddTool(){this.editingToolId=null,this.openDialog=!0},handleRowClick(e,{item:t}){this.editingToolId=t.id,this.openDialog=!0},fetchToolsByFilter(){this.editorToolStore.fetchToolsByFilter({search:this.searchQuery})},fetchToolsData(){this.editorToolStore.fetchToolsDynamicFilters(),this.fetchToolsByFilter()}}},mt=e=>(Me("data-v-17763748"),e=e(),Fe(),e),Ms={class:"text-right"},Fs={class:"index"},Vs={style:{"white-space":"nowrap"}},xs={key:0,style:{color:"yellow"}},Os={style:{"white-space":"nowrap"}},As={style:{"white-space":"nowrap"}},Es={key:0,class:"green"},Bs=mt(()=>d("span",{class:"grey"},"|",-1)),Ls={key:1,class:"red"},Us=mt(()=>d("span",{class:"grey"},"|",-1)),Hs={style:{"white-space":"nowrap"}};function Rs(e,t,o,c,a,n){const u=C("editor-tool-modal");return i(),y(V,null,{default:r(()=>[d("div",Ms,[l(k,{color:"blue",onClick:n.onAddTool},{prepend:r(()=>[l(w,null,{default:r(()=>[f("mdi-file-plus")]),_:1})]),default:r(()=>[f(" Новый инструмент ")]),_:1},8,["onClick"])]),a.openDialog?(i(),y(u,{key:0,persistent:!0,"tool-id":a.editingToolId,onCanceled:n.onClosePopup,onChangesSaved:n.handleSaveChanges},null,8,["tool-id","onCanceled","onChangesSaved"])):_("",!0),a.isDataLoaded?(i(),y(ce,{key:1,"no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.toolTableHeaders,items:n.formattedTools,"items-length":n.totalToolsCount,"items-per-page":n.itemsPerPage,page:n.currentPage,loading:n.isLoading,"items-per-page-options":[15,50,100,300],density:"compact",class:"elevation-1 scrollable-table",hover:"","fixed-header":"",width:"","onUpdate:page":n.handlePageChange,"onUpdate:itemsPerPage":n.handleItemsPerPageChange,"onClick:row":n.handleRowClick},{"item.index":r(({index:s})=>[d("td",Fs,p(n.calculateItemIndex(s)),1)]),"item.name":r(({item:s})=>[d("td",Vs,[d("span",{class:A({grey:!s.sklad||s.sklad===0})},p(s.name),3),s.group_id?(i(),y(O,{key:0,size:"x-small",color:n.getToolGroupColor(s.group_id),title:"Группа "+s.group_id},{default:r(()=>[s.group_standard?(i(),m("span",xs,"★")):_("",!0),f(" G"+p(s.group_id),1)]),_:2},1032,["color","title"])):_("",!0)])]),"item.sklad":r(({item:s})=>[d("td",Os,[l(O,{color:s.sklad===0?"red":""},{default:r(()=>[f(p(s.sklad),1)]),_:2},1032,["color"])])]),"item.norma":r(({item:s})=>[d("td",As,[s.norma_green?(i(),m("span",Es,[f(p(s.norma_green)+" ",1),Bs])):_("",!0),f(" "+p(s.norma)+" ",1),s.norma_red?(i(),m("span",Ls,[Us,f(" "+p(s.norma_red),1)])):_("",!0)])]),"item.zakaz":r(({item:s})=>[d("td",Hs,p(n.calculateToolOrder(s)),1)]),_:1},8,["headers","items","items-length","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage","onClick:row"])):_("",!0)]),_:1})}const Ns=I(Ss,[["render",Rs],["__scopeId","data-v-17763748"]]),zs={name:"Main",components:{Catalog:rs,ToolFilter:ht,Table:Ns},computed:{currentItem(){return Z().getCurrentItem}}},$s={class:"container"},Gs={key:0};function qs(e,t,o,c,a,n){var g;const u=C("Catalog"),s=C("ToolFilter"),h=C("Table");return i(),m("div",$s,[l(u),(g=n.currentItem)!=null&&g.elements?(i(),m("span",Gs,[l(s),l(h)])):_("",!0)])}const js=I(zs,[["render",qs]]),Qs={name:"IssueModal",components:{Modal:G},props:{toolId:{type:Number,default:null},toolTitle:{type:String,default:""}},emits:["canceled","changes-saved"],data:()=>({damagedQuantity:1,comment:null,selectedCnc:null,cncList:[],originalData:[],idMapping:{},isModalOpen:!0,selectedFio:null,fioOptions:[],selectedData:{name:null,description:null,no:null,type:null},localParentId:null,selectedParams:[],toolParams:[],confirmDeleteDialog:!1,typeSelected:!1,selectedType:"",operationMapping:{},options:{idNameDescription:[],numberType:[]},noCnc:!1}),computed:{...U("IssueToolStore",["nameOptions"]),...Qe("IssueToolStore",["parentCatalog"]),currentFolderName(){return this.toolId===null?this.idParent.label:this.tool.folder_name},popupTitle(){return this.toolId!=null?`Инструмент поврежден ID: ${this.toolId}`:"Ошибка нет ID"}},watch:{tool:{deep:!0,immediate:!0,async handler(e){e==null?this.resetToolModel():(await this.fetchToolById(e),this.updateToolModel())}}},async created(){try{const e=await Y.getDetailFio();this.fioOptions=this.prepareFioOptions(e)}catch(e){console.error("Ошибка при загрузке данных ФИО:",e)}try{const e=await Y.fetchCncList();this.cncList=e?[...e]:[],e&&Array.isArray(e)?this.cncList=e:console.error("Ошибка при получении списка станков:",e),this.toolId==null?this.setTool({id:null,name:null,property:{}}):(await this.fetchToolById(this.toolId),this.tool.property===null&&(this.tool.property={}))}catch(e){console.error("Ошибка в created:",e)}},methods:{...$("IssueToolStore",["setTool"]),...R("IssueToolStore",["fetchToolsByFilter","fetchToolById"]),prepareFioOptions(e){return e.map(t=>({text:t.fio,value:t.id}))},onCancel(){this.$emit("canceled")},async onSave(){try{const e={id_tool:this.toolId,id_user:this.selectedFio.value,cnc_code:this.noCnc?null:this.selectedCnc.cnc_code,comment:this.comment,quantity:this.damagedQuantity},t=await Y.addToolHistoryDamaged(e);t.success==="OK"?this.$emit("changes-saved"):console.error("Ошибка при сохранении данных о поврежденном инструменте: ",t)}catch(e){console.error("Ошибка при отправке данных о поврежденном инструменте: ",e)}}}};function Zs(e,t,o,c,a,n){const u=C("Modal");return i(),y(u,{title:n.popupTitle},{content:r(()=>[l(V,null,{default:r(()=>[l(S,null,{default:r(()=>[l(v,null,{default:r(()=>[d("div",null,[l(O,{size:"large",class:"mb-3",color:"red"},{default:r(()=>[f(p(o.toolTitle),1)]),_:1}),l(Te,{modelValue:e.noCnc,"onUpdate:modelValue":t[0]||(t[0]=s=>e.noCnc=s),label:"Без станка"},null,8,["modelValue"])]),l(L,{modelValue:e.selectedCnc,"onUpdate:modelValue":t[1]||(t[1]=s=>e.selectedCnc=s),items:e.cncList,label:"Выберите станок","item-title":"cnc_name","item-value":"cnc_code",rules:[s=>!!s||"Выберите станок",s=>!e.noCnc||"Выберите станок"],required:"","single-line":"false",disabled:e.noCnc},null,8,["modelValue","items","rules","disabled"]),l(F,{modelValue:e.damagedQuantity,"onUpdate:modelValue":t[2]||(t[2]=s=>e.damagedQuantity=s),modelModifiers:{number:!0},label:"Количество",type:"number",min:"1",rules:[s=>!!s||"Заполните поле",s=>s>0||"Количество должно быть больше 0"],required:""},null,8,["modelValue","rules"]),l(L,{modelValue:e.selectedFio,"onUpdate:modelValue":t[3]||(t[3]=s=>e.selectedFio=s),items:e.fioOptions,"item-title":"text","item-value":"value",label:"ФИО",rules:[s=>!!s||"Выберите ФИО"],"return-object":"false","single-line":"false"},null,8,["modelValue","items","rules"]),l(xt,{modelValue:e.comment,"onUpdate:modelValue":t[4]||(t[4]=s=>e.comment=s),class:"comment-field",label:"Комментарий",rows:"3",rules:[s=>!!s||"Заполните поле"],required:""},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"]),l(x),l(k,{"prepend-icon":"mdi-check-circle",class:"text-none text-subtitle-1 pl-3",color:"blue darken-1",size:"large",variant:"flat",onClick:n.onSave},{default:r(()=>[f(" Сохранить ")]),_:1},8,["onClick"])]),_:1},8,["title"])}const Ws=I(Qs,[["render",Zs]]),Ks={data(){return{searchQuery:"",openDialog:!1,isDataLoaded:!1,editingToolId:null,toolTableHeaders:[],filterParamsList:[],debouncedSearch:null}},computed:{...U("IssueToolStore",["toolsTotalCount","formattedTools","dynamicFilters","filters","parentCatalog","isLoading"]),groupedFilters(){const e=[];for(let o=0;o<this.dynamicFilters.length;o+=4)e.push(this.dynamicFilters.slice(o,o+4));return e}},async mounted(){await this.fetchToolsDynamicFilters(),this.debouncedSearch=this.debounce(this.onActualSearch,500),this.isDataLoaded=!0},methods:{...R("IssueToolStore",["fetchToolsDynamicFilters","fetchToolsByFilter"]),...$("IssueToolStore",["setCurrentPage","setItemsPerPage","setSelectedDynamicFilters"]),onActualSearch(){fe.commit("IssueToolStore/setSearch",this.searchQuery),fe.dispatch("IssueToolStore/fetchToolsByFilter")},debounce(e,t){let o;return function(...c){const a=()=>{o=null,e.apply(this,c)};clearTimeout(o),o=setTimeout(a,t)}},onSearch(){this.debouncedSearch()},onParamsFilterUpdate({key:e,value:t}){this.setSelectedDynamicFilters({...this.filters.selectedDynamicFilters,[e]:t}),this.fetchToolsByFilter()}}};function Js(e,t,o,c,a,n){return i(),m("div",null,[e.dynamicFilters&&e.dynamicFilters.length>0?(i(),y(S,{key:0},{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(F,{modelValue:a.searchQuery,"onUpdate:modelValue":[t[0]||(t[0]=u=>a.searchQuery=u),n.onSearch],variant:"outlined",clearable:"","append-icon":"mdi-magnify",label:"Поиск","hide-details":"",onInput:n.onSearch},null,8,["modelValue","onInput","onUpdate:modelValue"])]),_:1})]),_:1})):_("",!0),(i(!0),m(b,null,P(n.groupedFilters,(u,s)=>(i(),y(S,{key:`group-${s}`,cols:"12",sm:"6"},{default:r(()=>[(i(!0),m(b,null,P(u,h=>(i(),y(v,{key:h.key,cols:"12",sm:"3"},{default:r(()=>[l(L,{density:"compact",variant:"solo",clearable:"",label:h.label,items:h.values,value:e.filters.selectedDynamicFilters[h.key],"onUpdate:modelValue":g=>n.onParamsFilterUpdate({key:h.key,value:g})},null,8,["label","items","value","onUpdate:modelValue"])]),_:2},1024))),128))]),_:2},1024))),128))])}const Xs=I(Ks,[["render",Js]]);const Ys={components:{ToolFilter:Xs,ModalDamaged:Ws},props:{namespace:{type:String,default:"tool"}},emits:["changes-saved","canceled","page-changed","page-limit-changed"],data(){return{snackbarVisible:!1,snackbarText:"",openDialog:!1,isDataLoaded:!1,editingToolId:null,editingToolName:null,toolTableHeaders:[],filterParamsList:[],currentModal:null}},computed:{...U("IssueToolStore",["toolsTotalCount","formattedTools","dynamicFilters","filters","parentCatalog","isLoading","cartItems"])},watch:{"parentCatalog.id"(e){e!=null&&this.fetchToolsDynamicFilters()},dynamicFilters:{immediate:!0,handler(e){this.toolTableHeaders=[{title:"№",key:"index",sortable:!1},{title:"Маркировка",key:"name",sortable:!1},{title:"⭐Склад / Норма",key:"sklad",sortable:!1},{title:"Выдать",key:"cart",sortable:!1},{title:"Поврежден",key:"damaged",sortable:!1},...e&&e.length>0?e.map(({label:t,key:o})=>({title:t,key:o,sortable:!1})):[]]}}},async mounted(){await this.fetchToolsDynamicFilters(),this.isDataLoaded=!0},methods:{...R("IssueToolStore",["fetchToolsDynamicFilters","fetchToolsByFilter"]),...$("IssueToolStore",["setCurrentPage","setItemsPerPage","setSelectedDynamicFilters"]),async updateTableData(){await this.fetchToolsByFilter()},refreshData(){this.fetchToolsByFilter()},showSnackbar(e){this.snackbarText=e,this.snackbarVisible=!0},showModal(e){this.currentModalType=e,this.isModalOpen=!0},addToolToCart(e,t){const o=this.formattedTools.find(n=>n.id===e);if(!o){this.showSnackbar("Товар не найден.");return}const c=this.cartItems.find(n=>n.toolId===e),a=c?c.quantity+t:t;if(a>o.sklad){this.showSnackbar(`Невозможно добавить. На складе доступно только ${o.sklad}, в корзине уже ${c?c.quantity:0}.`);return}c?c.quantity+=t:this.cartItems.push({toolId:o.id,quantity:t,name:o.name,sklad:o.sklad}),this.showSnackbar(`${o.name} добавлен в корзину. В корзине ${a}, на складе ${o.sklad-a}.`)},onIssueTool(e,t){e.stopPropagation(),this.editingToolId=t.id,this.currentModal="issue",this.openDialog=!0},onDamagedTool(e,t){e.stopPropagation(),this.editingToolId=t.id,this.editingToolName=t.name,this.currentModal="damaged",this.openDialog=!0},onParamsFilterUpdate({key:e,value:t}){this.setSelectedDynamicFilters({...this.filters.selectedDynamicFilters,[e]:t}),this.fetchToolsByFilter()},async onChangePage(e){this.setCurrentPage(e),await this.fetchToolsByFilter()},async onUpdateItemsPerPage(e){this.setItemsPerPage(e),await this.fetchToolsByFilter()},colorClassGrey(e){return{grey:!e.sklad||e.sklad===0}},colorClassRed(e){return{red:!e.sklad||e.sklad===0}},calculateOrder(e){const t=e.norma-e.sklad;return t<0?"":t},onClosePopup(){this.openDialog=!1},onSaveChanges(){this.openDialog=!1,this.fetchToolsDynamicFilters(),this.fetchToolsByFilter()}}},er={class:"index"},tr={key:0,class:"grey"},or={style:{"white-space":"nowrap"}},lr={style:{"white-space":"nowrap"}};function ar(e,t,o,c,a,n){const u=C("tool-filter"),s=C("ModalDamaged");return i(),m(b,null,[l(de,{modelValue:a.snackbarVisible,"onUpdate:modelValue":t[0]||(t[0]=h=>a.snackbarVisible=h),timeout:8e3,bottom:"",right:"",color:"blue-grey"},{default:r(()=>[f(p(a.snackbarText),1)]),_:1},8,["modelValue"]),l(V,null,{default:r(()=>[l(u,{"filter-params-list":a.filterParamsList,filters:e.filters,onFilterUpdate:n.onParamsFilterUpdate},null,8,["filter-params-list","filters","onFilterUpdate"]),l(k,{color:"primary",class:"mb-2",onClick:n.refreshData},{default:r(()=>[l(w,{left:""},{default:r(()=>[f("mdi-refresh")]),_:1}),f(" Обновить ")]),_:1},8,["onClick"]),a.openDialog&&a.currentModal==="damaged"?(i(),y(s,{key:"modal-damaged",persistent:!0,"tool-id":a.editingToolId,"tool-title":a.editingToolName,onCanceled:n.onClosePopup,onChangesSaved:n.onSaveChanges,onClose:t[1]||(t[1]=h=>a.openDialog=!1)},null,8,["tool-id","tool-title","onCanceled","onChangesSaved"])):_("",!0),a.isDataLoaded?(i(),y(ce,{key:1,"no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.toolTableHeaders,items:e.formattedTools,"items-length":e.toolsTotalCount,"items-per-page":e.filters.itemsPerPage,page:e.filters.currentPage,loading:e.isLoading,"items-per-page-options":[15,50,100,300],density:"compact",class:"elevation-1 scrollable-table",hover:"","fixed-header":"",width:"","onUpdate:page":n.onChangePage,"onUpdate:itemsPerPage":n.onUpdateItemsPerPage},{"item.index":r(({index:h})=>[d("td",er,p(h+1),1)]),"item.name":r(({item:h})=>[d("td",{class:A(n.colorClassGrey(h)),style:{"white-space":"nowrap"}},[l(O,{size:"large",variant:"text"},{default:r(()=>[f(p(h.name),1)]),_:2},1024)],2)]),"item.sklad":r(({item:h})=>[d("td",{class:A(n.colorClassRed(h)),style:{"white-space":"nowrap"}},[l(O,{size:"large",color:"primary",variant:"flat"},{default:r(()=>[f(p(h.sklad),1)]),_:2},1024),h.norma?(i(),m("span",tr," / "+p(h.norma),1)):_("",!0)],2)]),"item.norma":r(({item:h})=>[d("td",or,p(h.norma),1)]),"item.zakaz":r(({item:h})=>[d("td",lr,p(n.calculateOrder(h)),1)]),"item.damaged":r(({item:h})=>[l(k,{color:"red",onClick:g=>n.onDamagedTool(g,h)},{default:r(()=>[l(w,{icon:"mdi-image-broken-variant"})]),_:2},1032,["onClick"])]),"item.cart":r(({item:h})=>[l(k,{color:"yellow",onClick:g=>n.addToolToCart(h.id,1)},{default:r(()=>[l(w,{icon:"mdi-cart-arrow-down"})]),_:2},1032,["onClick"])]),_:1},8,["headers","items","items-length","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage"])):_("",!0)]),_:1})],64)}const sr=I(Ys,[["render",ar],["__scopeId","data-v-d6493fb5"]]);const rr={name:"CatalogBreadcrumbs",props:{tree:{type:Array,default:()=>[]},currentItem:{type:Object,default:()=>null}},emits:["go-to","item-selected"],computed:{appColor(){return"cyan-darken-3"}},methods:{getBreadcrumbClass(e){return{"breadcrumbs-item":e<this.tree.length-1,"breadcrumbs-item-final":e===this.tree.length-1}},goTo(e){this.$emit("go-to",e)},async selectItem(e){this.$emit("item-selected",e)}}},nr=["onClick"],ir={key:0},dr={key:0},cr={key:0},ur={class:"flex"},hr={key:0,style:{color:"grey"}};function mr(e,t,o,c,a,n){return i(),m(b,null,[d("div",null,[(i(!0),m(b,null,P(o.tree,(u,s)=>(i(),m("span",{key:s},[d("span",{class:A(n.getBreadcrumbClass(s)),onClick:h=>n.goTo(s)},[f(p(u.label)+" ",1),u.available!==0?(i(),m("span",ir," ("+p(u.available)+") ",1)):_("",!0)],10,nr),s<o.tree.length-1?(i(),m("span",dr,"   /   ")):_("",!0)]))),128))]),o.currentItem&&o.currentItem.nodes?(i(),m("div",cr,[(i(!0),m(b,null,P(o.currentItem.nodes,u=>(i(),y(N,{key:u.id,class:"align-center",onClick:s=>n.selectItem(u)},{default:r(()=>[d("div",ur,[l(w,{color:n.appColor,icon:"mdi-folder",class:"icon"},null,8,["color"]),l(Ze,{class:A({"text-grey":u.totalElements===0})},{default:r(()=>[f(p(u.label)+" ",1),u.elements!==0?(i(),m("span",hr,[l(O,{variant:"text"},{default:r(()=>[f(p(u.available)+" / "+p(u.elements),1)]),_:2},1024)])):_("",!0)]),_:2},1032,["class"])])]),_:2},1032,["onClick"]))),128))])):_("",!0)],64)}const pt=I(rr,[["render",mr],["__scopeId","data-v-166a2151"]]);const pr={name:"IssueCatalog",components:{TabMainTable:sr,CatalogBreadcrumbs:pt},data(){return{fioOptions:[],selectedFio:null,operationMapping:{},options:{idNameDescription:[],numberType:[]},tree:[],currentItem:null,selectedItem:null,isEditing:!1,editableLabel:"",toolModel:{name:null,property:{},selectedOperationId:null,typeIssue:null}}},computed:{...U("IssueToolStore",["parentCatalog","cartItems"]),isTableShown(){return this.parentCatalog.id!==1}},watch:{currentItem:{handler(e){this.setParentCatalog({id:e.id,label:e.label}),this.fetchToolsByFilter()}}},async created(){const e=await B.getTree({folderNotNull:!0});e&&e.length>0&&(this.currentItem=e[0],this.tree.push(this.currentItem))},methods:{...$("IssueToolStore",["setSelectedOperationId","setSelectedDetail","setParentCatalog","setSelectedOperationId","setSelectedFio"]),...R("IssueToolStore",["fetchToolsByFilter"]),async selectItem(e){this.setParentCatalog({id:e.id,label:e.label}),this.currentItem=e,this.tree.includes(e)||this.tree.push(e)},goBack(){this.tree.length>1&&(this.tree.pop(),this.currentItem=this.tree[this.tree.length-1],this.setParentCatalog({id:this.currentItem.id,label:this.currentItem.label}))},goTo(e){this.currentItem=this.tree[e],this.setParentCatalog({id:this.currentItem.id,label:this.currentItem.label}),this.tree=this.tree.slice(0,e+1),this.currentItem=this.tree[e]}}},fr={class:"text-h6 pl-5"};function yr(e,t,o,c,a,n){const u=C("catalog-breadcrumbs"),s=C("TabMainTable");return i(),m(b,null,[l(be,{class:"custom-container"},{default:r(()=>[l(Ve,{app:"",dark:""},{default:r(()=>[d("div",fr,p(a.currentItem?a.currentItem.label:"Выдать"),1),l(x),l(k,{icon:"",onClick:n.goBack},{default:r(()=>[l(w,{icon:"mdi-arrow-left"})]),_:1},8,["onClick"])]),_:1}),l(_e,null,{default:r(()=>[l(V,{fluid:!0},{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(u,ee({tree:a.tree,currentItem:a.currentItem},{onGoTo:n.goTo,onItemSelected:n.selectItem}),null,16,["onGoTo","onItemSelected"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n.isTableShown?(i(),y(s,Ge(ee({key:0},{namespace:"IssueToolStore"})),null,16)):_("",!0)],64)}const gr=I(pr,[["render",yr]]),_r={data(){return{searchQuery:"",openDialog:!1,isDataLoaded:!1,editingToolId:null,toolTableHeaders:[],filterParamsList:[],debouncedSearch:null}},computed:{...U("ViewToolStore",["toolsTotalCount","formattedTools","dynamicFilters","filters","parentCatalog","isLoading"]),groupedFilters(){const e=[];for(let o=0;o<this.dynamicFilters.length;o+=4)e.push(this.dynamicFilters.slice(o,o+4));return e}},async mounted(){await this.fetchToolsDynamicFilters(),this.debouncedSearch=this.debounce(this.onActualSearch,500),this.isDataLoaded=!0},methods:{...R("ViewToolStore",["fetchToolsDynamicFilters","fetchToolsByFilter"]),...$("ViewToolStore",["setCurrentPage","setItemsPerPage","setSelectedDynamicFilters"]),onActualSearch(){fe.commit("ViewToolStore/setSearch",this.searchQuery),fe.dispatch("ViewToolStore/fetchToolsByFilter")},debounce(e,t){let o;return function(...c){const a=()=>{o=null,e.apply(this,c)};clearTimeout(o),o=setTimeout(a,t)}},onSearch(){this.debouncedSearch()},onParamsFilterUpdate({key:e,value:t}){this.setSelectedDynamicFilters({...this.filters.selectedDynamicFilters,[e]:t}),this.fetchToolsByFilter()}}};function br(e,t,o,c,a,n){return i(),m("div",null,[e.dynamicFilters&&e.dynamicFilters.length>0?(i(),y(S,{key:0},{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(F,{modelValue:a.searchQuery,"onUpdate:modelValue":[t[0]||(t[0]=u=>a.searchQuery=u),n.onSearch],variant:"outlined",clearable:"","append-icon":"mdi-magnify",label:"Поиск по инструменту","hide-details":"",onInput:n.onSearch},null,8,["modelValue","onInput","onUpdate:modelValue"])]),_:1})]),_:1})):_("",!0),(i(!0),m(b,null,P(n.groupedFilters,(u,s)=>(i(),y(S,{key:`group-${s}`,cols:"12",sm:"6"},{default:r(()=>[(i(!0),m(b,null,P(u,h=>(i(),y(v,{key:h.key,cols:"12",sm:"3"},{default:r(()=>[l(L,{density:"compact",variant:"solo",clearable:"",label:h.label,items:h.values,value:e.filters.selectedDynamicFilters[h.key],"onUpdate:modelValue":g=>n.onParamsFilterUpdate({key:h.key,value:g})},null,8,["label","items","value","onUpdate:modelValue"])]),_:2},1024))),128))]),_:2},1024))),128))])}const Tr=I(_r,[["render",br]]);const kr={components:{EditorToolModal:ut,ToolFilter:Tr},props:{namespace:{type:String,default:"tool"}},emits:[],data(){return{openDialog:!1,isDataLoaded:!1,editingToolId:null,toolTableHeaders:[],filterParamsList:[]}},computed:{...U("ViewToolStore",["toolsTotalCount","formattedTools","dynamicFilters","filters","parentCatalog","isLoading"])},watch:{"parentCatalog.id"(e){e!=null&&this.fetchToolsDynamicFilters()},dynamicFilters:{immediate:!0,handler(e){this.toolTableHeaders=[{title:"№",key:"index",sortable:!1},{title:"Маркировка",key:"name",sortable:!1},...e&&e.length>0?e.map(({label:t,key:o})=>({title:t,key:o,sortable:!1})):[],{title:"Норма",key:"norma",sortable:!1},{title:"Склад",key:"sklad",sortable:!1}]}}},async mounted(){await this.fetchToolsDynamicFilters(),this.isDataLoaded=!0},methods:{...R("ViewToolStore",["fetchToolsDynamicFilters","fetchToolsByFilter"]),...$("ViewToolStore",["setCurrentPage","setItemsPerPage","setSelectedDynamicFilters"]),onClosePopup(){this.openDialog=!1},onEditRow(e,{item:t}){this.editingToolId=t.id,this.openDialog=!0},onParamsFilterUpdate({key:e,value:t}){this.setSelectedDynamicFilters({...this.filters.selectedDynamicFilters,[e]:t}),this.fetchToolsByFilter()},async onChangePage(e){this.setCurrentPage(e),await this.fetchToolsByFilter()},async onUpdateItemsPerPage(e){this.setItemsPerPage(e),await this.fetchToolsByFilter()},colorClassGrey(e){return{grey:!e.sklad||e.sklad===0}},colorClassRed(e){return{red:!e.sklad||e.sklad===0}},calculateOrder(e){const t=e.norma-e.sklad;return t<0?"":t}}},vr={class:"index"},Ir={style:{"white-space":"nowrap"}},Cr={style:{"white-space":"nowrap"}};function wr(e,t,o,c,a,n){const u=C("tool-filter"),s=C("editor-tool-modal");return i(),y(V,null,{default:r(()=>[l(u,{"filter-params-list":a.filterParamsList,filters:e.filters,onFilterUpdate:n.onParamsFilterUpdate},null,8,["filter-params-list","filters","onFilterUpdate"]),a.openDialog?(i(),y(s,{key:0,persistent:!0,"tool-id":a.editingToolId,onCanceled:n.onClosePopup,onChangesSaved:e.onSaveChanges},null,8,["tool-id","onCanceled","onChangesSaved"])):_("",!0),a.isDataLoaded?(i(),y(ce,{key:1,"no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.toolTableHeaders,items:e.formattedTools,"items-length":e.toolsTotalCount,"items-per-page":e.filters.itemsPerPage,page:e.filters.currentPage,loading:e.isLoading,"items-per-page-options":[15,50,100,300],density:"compact",class:"elevation-1 scrollable-table",hover:"","fixed-header":"",width:"","onUpdate:page":n.onChangePage,"onUpdate:itemsPerPage":n.onUpdateItemsPerPage,"onClick:row":n.onEditRow},{"item.index":r(({index:h})=>[d("td",vr,p(h+1),1)]),"item.name":r(({item:h})=>[d("td",{class:A(n.colorClassGrey(h)),style:{"white-space":"nowrap"}},p(h.name),3)]),"item.sklad":r(({item:h})=>[d("td",{class:A(n.colorClassRed(h)),style:{"white-space":"nowrap"}},p(h.sklad),3)]),"item.norma":r(({item:h})=>[d("td",Ir,p(h.norma),1)]),"item.zakaz":r(({item:h})=>[d("td",Cr,p(n.calculateOrder(h)),1)]),_:1},8,["headers","items","items-length","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage","onClick:row"])):_("",!0)]),_:1})}const Pr=I(kr,[["render",wr],["__scopeId","data-v-915b565c"]]);const Dr={name:"ViewCatalog",components:{TabMainTable:Pr,CatalogBreadcrumbs:pt},data(){return{tree:[],currentItem:null,selectedItem:null,isEditing:!1,editableLabel:""}},computed:{ViewToolStore(){return it},...U("ViewToolStore",["parentCatalog"]),isTableShown(){return this.parentCatalog.id!==1}},watch:{currentItem:{handler(e){this.setParentCatalog({id:e.id,label:e.label}),this.fetchToolsByFilter()}}},async created(){const e=await B.getTree();e&&e.length>0&&(this.currentItem=e[0],this.tree.push(this.currentItem))},methods:{...$("ViewToolStore",["setParentCatalog"]),...R("ViewToolStore",["fetchToolsByFilter"]),async renameCurrentItem(){const e=this.currentItem.id,t=this.editableLabel;try{const o=await B.renameFolder(e,t);if(o&&o.message){alert("Папка успешно переименована."),this.currentItem.label=t;const c=this.tree.find(a=>a.id===e);c&&(c.label=t)}else alert("Произошла ошибка при переименовании.")}catch(o){console.error("Ошибка при переименовании:",o),alert("Произошла ошибка при переименовании.")}},async deleteItem(){if(!this.currentItem)return alert("Не выбрана папка для удаления.");const e=this.currentItem.id;if(confirm(`Уверены, что хотите удалить ${this.currentItem.label}?`))try{await B.deleteFolder(e),alert("Папка успешно удалена."),this.tree.length>1&&(this.tree.pop(),this.currentItem=this.tree[this.tree.length-1]),await this.refreshTree()}catch(t){console.error("Ошибка при удалении:",t),alert("Произошла ошибка при удалении.")}},async addItem(){if(!this.currentItem||!this.currentItem.nodes)return alert("Выберите категорию для добавления новой папки.");let e=prompt("Введите название новой ветки:");if(e)try{const o={id:(await B.addFolder(e,this.currentItem.id)).newBranchId,label:e,elements:0,nodes:[]};this.currentItem.nodes.push(o),this.currentItem=o,this.tree.push(o)}catch{alert("Произошла ошибка при добавлении ветки.")}},async refreshTree(){const e=await B.getTree();this.tree=e;const t=e.find(o=>o.id===this.currentItem.id);this.currentItem=t||(e.length>0?e[0]:null)},async selectItem(e){this.setParentCatalog({id:e.id,label:e.label}),this.currentItem=e,this.tree.includes(e)||this.tree.push(e)},startEditing(){this.isEditing=!0,this.editableLabel=this.currentItem?this.currentItem.label:""},finishEditing(){this.isEditing&&this.currentItem&&this.editableLabel!==this.currentItem.label&&this.renameCurrentItem(),this.isEditing=!1},goBack(){this.tree.length>1&&(this.tree.pop(),this.currentItem=this.tree[this.tree.length-1],this.setParentCatalog({id:this.currentItem.id,label:this.currentItem.label}))},goTo(e){this.currentItem=this.tree[e],this.setParentCatalog({id:this.currentItem.id,label:this.currentItem.label}),this.tree=this.tree.slice(0,e+1),this.currentItem=this.tree[e]}}},Sr={class:"text-h6"},Mr={class:"text-h6 pl-5"};function Fr(e,t,o,c,a,n){const u=C("catalog-breadcrumbs"),s=C("TabMainTable");return i(),m(b,null,[l(be,{class:"custom-container"},{default:r(()=>[l(Ve,{app:"",dark:""},{default:r(()=>[l(We,null,{default:r(()=>[d("div",Sr,[d("div",Mr,p(a.currentItem?a.currentItem.label:"Выдать"),1)])]),_:1}),l(x),l(k,{icon:"",onClick:n.goBack},{default:r(()=>[l(w,{icon:"mdi-arrow-left"})]),_:1},8,["onClick"])]),_:1}),l(_e,null,{default:r(()=>[l(V,{fluid:!0},{default:r(()=>[l(S,null,{default:r(()=>[l(v,{cols:"12"},{default:r(()=>[l(u,ee({tree:a.tree,currentItem:a.currentItem},{onGoTo:n.goTo,onItemSelected:n.selectItem}),null,16,["onGoTo","onItemSelected"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),n.isTableShown?(i(),y(s,Ge(ee({key:0},{namespace:"ViewToolStore"})),null,16)):_("",!0)],64)}const Vr=I(Dr,[["render",Fr]]),xr=[{name:"Редактор",url:"#editor",component:q(js),access:["Admin","Editor"],ico:"mdi-pencil"},{name:"Параметры",url:"#params",component:q(wl),access:["Admin","Editor"],ico:"mdi-playlist-plus"},{name:"Группы",url:"#groups",component:q(ql),access:["Admin","Editor"],ico:"mdi-format-list-group"},{name:"Выдать / поврежден",url:"#issue",component:q(gr),access:["Admin","Editor","Issue"],ico:"mdi-list-status"},{name:"История выдачи",url:"#history_issue",component:q(il),access:["Admin","Editor","Issue"],ico:"mdi-history"},{name:"История поврежденного",url:"#history_damaged",component:q(bl),access:["Admin","Editor","Issue"],ico:"mdi-history"},{name:"Просмотр",url:"#view",component:q(Vr),access:["Admin","View","Editor"],ico:"mdi-eye"},{name:"Дерево",url:"#tree",component:q(oa),access:["Admin","Editor","Issue","View"],ico:"mdi-file-tree"},{name:"Заказ",url:"#report",component:q(Na),access:["Admin","Editor","Issue"],ico:"mdi-package-variant"}],Or={data(){return{tab:null,tabs:[]}},computed:{appColor(){return"cyan-darken-3"}},watch:{tab(){let e=this.tabs.find(t=>t.name===this.tab);window.location.hash=e.url}},mounted(){let e=this.tabs.find(t=>t.url===window.location.hash);e!==void 0&&(this.tab=e.name),this.checkAccess()},methods:{async checkAccess(){try{const e=await ye.checkLogin();e.status==="ok"?(this.tabs=xr.filter(t=>t.access.includes(e.role)),this.tabs.length>0&&(this.tab=this.tabs[0].name)):console.error("Ошибка доступа:",e.message)}catch(e){console.error("Ошибка проверки авторизации:",e.message)}},async submit(){if(this.formValid)try{const e=await ye.login({login:this.login,password:this.password});e.status==="ok"?(localStorage.setItem("token",e.token),this.$router.push("/")):(this.showError=!0,this.errorMessage="Неправильный логин или пароль")}catch(e){this.showError=!0,this.errorMessage=e.message,console.error("Ошибка входа:",e)}}}};function Ar(e,t,o,c,a,n){return i(),y(ge,null,{default:r(()=>[l(Ot,{modelValue:a.tab,"onUpdate:modelValue":t[0]||(t[0]=u=>a.tab=u)},{default:r(()=>[(i(!0),m(b,null,P(a.tabs,u=>(i(),y(Et,{key:u.name,value:u.name},{default:r(()=>[l(w,{size:"large",color:n.appColor,class:"mr-2"},{default:r(()=>[f(p(u.ico),1)]),_:2},1032,["color"]),f(" "+p(u.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),l(Ke,null,{default:r(()=>[l(At,{modelValue:a.tab,"onUpdate:modelValue":t[1]||(t[1]=u=>a.tab=u)},{default:r(()=>[(i(!0),m(b,null,P(a.tabs,u=>(i(),y(Bt,{key:`window-item-${u.name}`,value:u.name},{default:r(()=>[(i(),y(Lt(u.component),{key:`component-${u.name}-${a.tab}`}))]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})}const Er=I(Or,[["render",Ar]]),Br=Object.freeze(Object.defineProperty({__proto__:null,default:Er},Symbol.toStringTag,{value:"Module"})),Lr={name:"HistoryModal",components:{Modal:G},props:{idPart:{type:Number,default:null}},emits:["canceled","operation-cancelled"],data(){return{info:null,originalData:[],selectedOperation:"all",availableOperations:[],headers:[{title:"Инструмент",value:"name_tool"},{title:"Кол-во",value:"quantity",width:"90px"},{title:"Выдано",value:"user_fio"},{title:"Дата",value:"date"},{title:"Операция",value:"no_oper"},{title:"Тип",value:"type_oper"}],headersAll:[{title:"Инструмент",value:"name_tool"},{title:"Дата начальная",value:"date"},{title:"Кол-во",value:"quantity",width:"90px"}],filteredData:[],showOperationModal:!1,currentNoOper:null}},computed:{popupTitle(){return`Инструмент затраченный на партию: ${this.id_part}`},currentHeaders(){return this.selectedOperation==="all"?this.headersAll:this.headers}},created(){this.fetchHistoryData()},methods:{filterData(){this.filteredData=this.selectedOperation==="all"?this.originalData.all||[]:this.originalData[this.selectedOperation]||[]},formatDate(e){try{return z(Q(e),"dd.MM.yy HH:mm:ss")}catch(t){return console.error("Error formatting date:",t,"Date:",e),"Invalid Date"}},onCancel(){this.$emit("canceled")},async fetchHistoryData(){try{const e=await ct.fetchHistoryByPartId(this.id_part);if(this.info=e.info,e&&typeof e=="object"){const{...t}=e;this.originalData=t,this.filteredData=t.all||[],this.availableOperations=Object.keys(t)}else this.originalData={},this.filteredData=[],this.availableOperations=["all"]}catch(e){console.error("Error fetching history data:",e)}}}},Ur={style:{"padding-left":"16px"}},Hr={key:0,style:{"padding-left":"25px"}};function Rr(e,t,o,c,a,n){const u=C("Modal",!0);return i(),y(u,{title:n.popupTitle,"width-default":"1300px"},{content:r(()=>[d("div",Ur,[l(S,null,{default:r(()=>[a.info?(i(),m("h2",Hr,p(a.info.name)+" "+p(a.info.description),1)):_("",!0),l(x),l(v,{cols:"12",md:"3"},{default:r(()=>[l(W,{modelValue:a.selectedOperation,"onUpdate:modelValue":[t[0]||(t[0]=s=>a.selectedOperation=s),n.filterData],label:"Операция",items:a.availableOperations,solo:""},null,8,["modelValue","items","onUpdate:modelValue"])]),_:1})]),_:1})]),l(H,{class:"elevation-1"},{default:r(()=>[d("thead",null,[d("tr",null,[(i(!0),m(b,null,P(n.currentHeaders,s=>(i(),m("th",{key:s.value,class:"text-left"},p(s.title),1))),128))])]),d("tbody",null,[(i(!0),m(b,null,P(a.filteredData,s=>(i(),m("tr",{key:s.id,class:A({"bg-blue-darken-2":s.type==="sum"})},[(i(!0),m(b,null,P(n.currentHeaders,h=>(i(),m("td",{key:h.value},[h.value==="date"?(i(),m(b,{key:0},[f(p(n.formatDate(s[h.value])),1)],64)):(i(),m(b,{key:1},[f(p(s[h.value]),1)],64))]))),128))],2))),128))])]),_:1})]),action:r(()=>[l(k,{color:"red darken-1",variant:"text",class:"text-none text-subtitle-1 ml-3",onClick:n.onCancel},{default:r(()=>[f(" Закрыть ")]),_:1},8,["onClick"])]),_:1},8,["title"])}const Nr=I(Lr,[["render",Rr]]),tt=te.create({baseURL:Xe("laravel")});function ot(e){return e.data}const zr={getQrCodeData:async(e,t)=>tt.get("/qr-code",{params:{page:e,perPage:t}}).then(ot).catch(T),addQrCodeData:async()=>tt.post("/qr-code").then(ot).catch(T)};const $r={components:{EditToolModal:Nr},emits:["changes-saved"],data(){return{openDialog:!1,filters:{itemsPerPage:15,currentPage:1},isLoading:!1,showModal:!1,toolsHistory:[],editingToolId:null,totalCount:0,headers:[{title:"ID",value:"id",sortable:!1},{title:"ID Спецификации",value:"specs_nom_id",sortable:!1},{title:"ID Операции",value:"specs_nom_operations_id",sortable:!1},{title:"Цвет",value:"color",sortable:!1},{title:"Статус",value:"status",sortable:!1},{title:"Смена",value:"smena",sortable:!1},{title:"Размеры",value:"sizes",sortable:!1},{title:"Дата создания",value:"created_at",sortable:!1},{title:"Кол-во коробок",value:"quantity_box",sortable:!1},{title:"Кол-во произведенного",value:"quantity_prod",sortable:!1}]}},async mounted(){await this.fetchAndFormatToolHistory()},methods:{async onChangePage(e){this.filters.currentPage=e,await this.fetchAndFormatToolHistory()},async onUpdateItemsPerPage(e){this.filters.itemsPerPage=e,await this.fetchAndFormatToolHistory()},formatDate(e){return z(Q(e),"dd.MM.yy HH:mm")},async fetchAndFormatToolHistory(){try{this.isLoading=!0;const e=await zr.getQrCodeData(this.filters.currentPage,this.filters.itemsPerPage);e?(this.toolsHistory=e.data.map(t=>({...t,created_at:t.created_at?this.formatDate(t.created_at):null})),this.totalCount=e.totalCount):console.error("API request returned empty or invalid data:",e)}catch(e){console.error("Error fetching tool history:",e)}finally{this.isLoading=!1}},onClosePopup(){this.openDialog=!1},onSaveChanges(){this.openDialog=!1,this.$emit("changes-saved")}}};function Gr(e,t,o,c,a,n){const u=C("edit-tool-modal");return i(),y(V,null,{default:r(()=>[a.openDialog?(i(),y(u,{key:0,persistent:!0,id_part:a.editingToolId,onCanceled:n.onClosePopup,onChangesSaved:n.onSaveChanges},null,8,["id_part","onCanceled","onChangesSaved"])):_("",!0),a.toolsHistory&&a.toolsHistory.length>0?(i(),y(ce,{key:1,"no-data-text":"Нет данных","items-per-page-text":"Пункты на странице:","loading-text":"Загрузка данных",headers:a.headers,"items-length":a.totalCount,items:a.toolsHistory,"items-per-page":a.filters.itemsPerPage,page:a.filters.currentPage,loading:a.isLoading,"items-per-page-options":[15,50,100,300],hover:"","fixed-header":"",width:"true",class:"scrollable-table","onUpdate:page":n.onChangePage,"onUpdate:itemsPerPage":n.onUpdateItemsPerPage},{"item.color":r(({item:s})=>[l(w,{color:s.color,size:"24"},{default:r(()=>[f("mdi-circle")]),_:2},1032,["color"])]),_:1},8,["headers","items-length","items","items-per-page","page","loading","onUpdate:page","onUpdate:itemsPerPage"])):_("",!0)]),_:1})}const qr=I($r,[["render",Gr]]),jr=Object.freeze(Object.defineProperty({__proto__:null,default:qr},Symbol.toStringTag,{value:"Module"})),Qr={name:"Error404"},Zr=d("h1",null,"Нет такой страницы 404",-1),Wr=[Zr];function Kr(e,t,o,c,a,n){return i(),m("div",null,Wr)}const Jr=I(Qr,[["render",Kr]]),Xr=Object.freeze(Object.defineProperty({__proto__:null,default:Jr},Symbol.toStringTag,{value:"Module"}));export{tn as c,on as g};
